%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pangloss: Testing the reconstruction paper
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

% \voffset=-0.8in

% Packages:
\input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}

% Macros:
\input{macros.tex}
\input{addresses.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Line of Sight Mass Reconstruction]
{Inferring Lensing Mass in the Universe \\
from Photometric Catalog Data}
    
\author[Collett \etal]{%
  Thomas~E.~Collett$^{1}$\thanks{\collettemail},
  Philip~J.~Marshall$^{2}$,
  Matthew~W.~Auger$^{1}$,
  Stefan~Hilbert$^{3}$,
\newauthor{%
  Sherry~H.~Suyu$^{4}$,
  Zachary~Greene$^{4}$,
  Tommaso~Treu$^{4}$\thanks{\packard},
  Christopher~D.~Fassnacht$^{5}$,}
\newauthor{%
  L\`eon~V.~E.~Koopmans$^{6}$,
  Roger~D.~Blandford$^{3}$} 
  \medskip\\
  $^1$\ioa\\
  $^2$\oxford\\
  $^3$\kipac\\
  $^4$\ucsb\\
  $^5$\davis\\
  $^6$\kapteyn
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2012}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract} 
abstract
\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing   --
  methods: statistical    --
  galaxies: halos         --
  gaaxies: mass function  --
  cosmology: observations
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\todo{Phil,(+ Tom)}{Update introduction to reflect the scope of this paper}

Every distant object we observe has had its shape distorted, and size
and total brightness magnified (or demagnified) by a compound lens constructed
from all the mass distributed between us and it. As \citet{valewhite2003} and \citet{hilbert}
showed, there are no empty lightcones in our universe. This fact makes gravitational lensing a potentially important source of systematic error for any estimate of luminosity or distance.

\citet{suyu} found that in time delay lens cosmography the
lensing effect of mass structures along the (unusually over-dense) line of
sight to the quadruply-imaged radio source B1608$+$656, the so-called ``external
convergence'' $\kappax$, was the dominant source of uncertainty in the inferred
cosmological parameters. The problem is that one simply doesn't know
how magnified and distorted the source has been because the unlensed source is unobservable. The external shear can potentially be recovered in the mass-modelling of the lens, but the convergence is undetectable from the image positions, shapes and relative fluxes; this is the famous {\emph{  mass sheet-degeneracy}} \citep[see e.g.][for details]{falco}.

\notes{Previous work, what we are doing, why it will help}


\begin{figure}
\includegraphics[width=\columnwidth]{figs/view_of_a_lightcone.eps}
\caption[magcut]{View of a lightcone}
\label{fig:lightcone}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical Background}
\label{sec:theory}
\todo{Phil,(+ Tom)}{Modify the current theory section}

\notes{what is $\kappa$ from a single object, how does it combine given lots of objects along the line of sight, why kappa can't be extracted - mass sheet degeneracy, how $\kappa$ effects inferred parameters}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Estimating external convergence: The halo model approximation}
\label{sec:model}
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\notes{given perfect knowledge of the density near a line of sight it is possible to raytrace, but this can't be done for a real line of sight, since the mass distribution isn't known. Galaxies are known due to their light. Need to infer z and $\Mstar$ and turn these into $\Mh$ which can be used to infer $\kappah$ for each halo. Will never know voids, filaments or other dark structures, so a calibration is needed to convert $\kappah$ into $\kappa$}


For real lines of sight, we would like to estimate the external convergence as best we can given all
data available. Typically this data is in the form of a photometric galaxy
catalog, containing positions, brightnesses, colours, and possibly spectra for each galaxy in the
field of the lens, down to some magnitude
limit. Since we can not observe the surface mass density of each halo
directy, we need some way of estimating
the mass of each halo in the catalog, so that we can compute its
contribution to the total $\kappax$ along the line of sight. This mass assignment recipe will be uncertain, but
can be calibrated with cosmological simulations.

Transforming the photometometric galaxy catalogue into a  catalogue of
halo masses, positions, and redshifts, will enable us to attempt a
reconstruction of the convergence induced by every halo near a line of sight.
This is the subject of Section \ref{subsec:halos}. We also need to account for
the mass in the Universe that is not associated with the galaxies we can see
-- this is the subject of Section \ref{subsec:voids}. 

\subsection{Halos}
\label{subsec:halos}
\todo{Tom,Phil}{Check}

\notes{halo profile; justfication, choice of truncation. Infer concentration from halo mass using a relation.}
Cosmological dark matter simulations have shown that dark matter
halos are well approximated by NFW profiles \citep{NFW}, with a density
profile given by
\be\label{eq:rhonfw}
\rho(r) = 
\frac{\rho_0}{\left(r/r_{s}\right)
\left(1+r/r_{s}\right)^{2}},
\ee
where $r_{s}$ is a characteristic radius of the cluster, representing where
the density slope transitions from $r^{-1}$ to $r^{-3}$. This radius is related
to the virial radius of the halo by $r_{s}~=~r_{200}/c$, where $r_{200}$ is the radius at 
which 
\be
\rho(r_{200}) = 200\rho_{{\mathrm{crit}}}(z), \text{ where } \rho_{\mathrm{crit}}(z) \equiv \frac{3H^{2}(z)}{8\pi G}
\ee
and $c$ is the concentration parameter, which can be estimated from the halo's mass,
using a mass--concentration relation. Typically more massive halos are less concentrated,
but there is some scatter; we use the relation of \citet{Neto2007} to estimate $c$
from the mass enclosed within $r_{200}$, which we denote as $M_{200}$. We find our results do not change if the \citet{Macchio} Mass--concencetration relation is used instead. The best fit relation of \citet{Neto2007} is given by
\be
c_{200} = 4.67 (M_{200}/10^{14} h^{-1} \Msun)^{-0.11}.
\ee
$\rho_0$ is calculated from the critical density and concentration parameter:
\be
\rho_0 = \rho_{\mathrm{crit}}(z)\frac{200}{3}\frac{c^{3}}{\ln(1+c)-c/(1+c)}.
\ee


Unphysically, if one integrates the density profile of an NFW profile, the total mass is divergent.
Similarly, if the universe is homogeneously populated with NFW halos, the projected surface mass along any
line of sight will also be divergant\footnote{At large radius, $\Sigma_{\rm
nfw} \propto R^{-2}$, but the differential number of halos centred within an
annulus of width $\dee R$ is given by $\dee N_{\rm annulus} \propto R \dee R$,
so  $\Sigma_{\rm total} \propto \int_{0}^{\infty} R^{-1} \dee R$, which
diverges logarithmically}. Since infinite mass is unphysical, the profile must
be truncated at some point. Several truncation profiles have been suggested \citep[e.g][]{BMO}, but beyond several virial radii, the amount of matter associated with a halo is likely to be low. In this work we assume the truncated NFW profile of \citet{BMO}
\be\label{eq:bmoprofile}
\rho(r) = 
\frac{\rho_{\rm NFW} (r)}{1+\left(r/r_{t}\right)^2},
\ee
which is the same as the NFW profile in the limit that the truncation radius, $r_t$ goes to infinity. We use a truncation radius of five times the virial radius, but our results are robust for any choice of $r_t>2 \times r_{200}$.

The convergence and shear for the BMO profile are given in Appendix \ref{appendix:halos}.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Correcting for voids, filaments and dark structures}
\label{subsec:voids}

Whilst halos contribute a positive convergence to $\kappa$, voids contribute
a negative convergence. When a raybundle passes through a  region of space
that is less dense than $\rho_{\rm cr}(z)$ the rays are de-focused\footnote{In
principle, the convergence caused by halos, is also caused by the overdensity,
but we neglect this effect since halos are typically much more dense than the
intergalactic medium}. Whilst the  full raytraced solution takes into account
the effect of voids, our reconstruction cannot -- the halo catalogue does not
include voids. In principle the absence of a halo could be taken to infer a
void, but the under-density of such a void is hard to infer. Neglecting voids
would lead to a heavily biased estimate of $\kappa$. We account for the voids
statistically; we reconstruct
the $\kappa$ contribution of halos for an ensemble of calibration sightlines
and form the joint distribution P($\kappa,\kappah$). The calibration
can then be accounted for by marginalizing over all lines of sight with a similar
 $\kappah$.  We will refer to this calibration proceedure as the "void correction",
although it also accounts for all of the physics that our simple spherical halo prescription
neglects in a statistical manner. For each line of sight we create a $\pr(\kappa)$ from
\be
\label{eq:voidcorrection}
\pr(\kappax)=\int_{-\infty}^{+\infty}\pr(\kapparay',\tilde\kappa'_{\rm h})W(\kappah)\dee \tilde\kappa'_{\rm h}
\ee
where $\tilde{\kappah}$ is the median of the reconstructed $\kappah$ for each line of sight and $W(\kappah)$ is the reconstructed PDF for $\kappah$ where the $\kappah$ is recreated using a uniform prior.
Primed qunatities refer to all of the calibration sightlines and unprimed refers to the specific line of sight. Equation \ref{eq:voidcorrection} is the same as 
\be
\label{eq:voidcorrection2}
\pr(\kappax)=\int_{-\infty}^{+\infty}\pr(\kapparay'|\tilde\kappa'_{\rm h})\pr(\kappah)\dee \tilde\kappa'_{\rm h}
\ee
but with $\pr(\kappah)$ created with the global $\kappah$ distribution as a prior on $\kappah$.


\notes{Outline EXPLICITLY the proceedure we use to correct for voids etc}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Using the Millenium Simulation to test the halo model approximation with known halo mass and redshift}
\label{sec:knownMh+z} 

In order to justify the reconstruction proceedure outlined in Section \ref{sec:model}, we would like to apply it to lines of sight with known $\kappa$.\notes{can't use real los, have to use \MS} 


\subsection{Ray-tracing through simulated Lines of Sight}
\label{subsec:raytracing}
\todo{Stefan}{Write section on how the ray tracing was done}

\subsection{Generating mock lightcones from simulations}
\todo{Stefan}{Write section on how halos are extracted from the MS n-body particles}

\notes{view of a lightcone figure should go at the end of this section}
\subsection{How does $\kappah$ relate to $\kappa$?}

Given the halo mass catalogue from the Millenium Simulation, 
and convergence maps produced by ray-tracing through the MS's n-body particles, 
it is possible to test the validity of the prescription outlined
in Section \ref{sec:model}. In this section we test reconstruction prescription given perfect
knowledge of the halos' virial masses and redshifts; this provides us with a measure of the intrinsic
errors induced by treating matter as truncated NFW halos. 
We test the model by comparing $\kappah$ against
the ray-traced $\kappa$. If the reconstruction process is to be
succesfull the two quantities should be closely related, although
we expect $\kappah$ to be offset from $\kappa$ since the former 
does not include the divergence due to voids. Figure \ref{fig:isitbiased} shows that indeed $\kappah$ is a good estimator, regardless of the individual value of $\kappah$. At fixed $\kappah$ we find that the scatter in $\kapparay$ grows with $\kappah$; our reconstruction is better at reproducing underdense lines of sight than overdense lines of sight.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/cornerplot.eps}
\caption[Biased?]{$\kappah$ verses $\kappa$ for 100000 reconstructed lines of sight. $\kappah$ traces $\kappa$, but with a non-zero offset which is due to the negative convergence from voids. At fixed $\kappah$ the scatter in $\kappa$ grows with $\kappah$.}
\label{fig:isitbiased}
\end{figure}

%\subsubsection{How does $\gammah$ relate to $\gamma$?}

\subsection{How succesful is the calibration at converting $\kappah$ into $\kappa$?}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/globaldist.eps}
\caption[magcut]{Do we recover the global distribution?}
\label{fig:globaldist}
\end{figure}

Since voids are not included in the halo model approximation $\kappah$ is a biased estimator of $\kappa$, but this can be calibrated for useing the proceedure of Section \ref{sec:voids}. Taking the reconstructed $\sumkappah$ for $1\times 10^{5}$ lines of sight we form the joint distribution, P$(\kapparay,\kappah)$ and marginalize over P$(\kappah)$ to give P($\kappax$). We define the bias as the difference between the expectation value of $\kappax$ and the known true value of $\kapparay$ for each Line of sight and we define the reconstruction width, $\sigma_{\kappa}$,as half the width of the interval containing the central $68\%$ of the probability P($\kappax$). From $1\times 10^{4}$ reconstructed lines of sight we find the the bias to have mean of $-9.5\times 10^{-6}$ and a mean reconstruction width of 0.0132 which is roughly 1.8 times smaller than the width of the global P$(\kappax)$. We find that our $\kappa$ distributions are consistent with the global $\kappa$ distribution; Figure \ref{fig:globaldist} shows that the renormalized sum of $\pr(\kappa)$ from 10000 lines of sight is very similar to the global $\pr(\kappa)$.

\subsection{Which halos dominate the $\kappah$ distribution?}

Before investigating the errors caused by imperfect knowledge of halo mass and redshift, we investigate the errors induced by a magnitude limited reconstruction and a field of view limited reconstruction. The halos in our catalogue are given magnitudes by the semi-analytic model of \citet{deLucia+Blaizot2007} and by applying magnitude cuts to our catalogue, we can investigate the scatter caused by unobserved halos. The majority of the convergence comes from halos with an $i$ magnitude between 18 and 24. Figure \ref{fig:where} shows the cumulative contribution to $\kappah$ as a function of projected distance from the line of sight, magnitude and redshift. Unsurprisingly we find that most of the convergence comes from halos whose galaxies are close to the line of sight. As a function of magnitude, we find that $\kappah$ is dominated by objects with magnitudes between $i=18$ and $i=24$. Objects brighter than $i=18$ are either too rare or too close to the observer to make a significant contribution to the convergence. Objects fainter than $i=24$ are too small to be important, unless they are extremely close to the line of sight, but we find that including including halos fainter than $i=24$ does not improve our reconstruction. Figure \ref{fig:magcut} shows the scatter on $\kappah-\kappa$ (where $\kappah$ is shifted so that it's mean is zero) as a function of reconstruction magnitude limit. Since these objects must be extremely close to the line of sight to make a non-zero $\kappah$ contribution it is likely that neglecting stellar mass and using a spherical NFW prescription are too naive to adequately reconstruct $\kappax$; thus we do not expect a deeper survey to decrease the size of the uncertainty in mapping $\kappah$ onto $\kappa$. We find that halosat all redshifts contribute to the convergence, but halos half way between observer and source tend to have the largest individual contributions.  


\begin{figure*}
\includegraphics[width=\textwidth]{figs/where_is_the_kappa.eps}
\caption[magcut]{Which objects dominate kappa?}
\label{fig:where}
\end{figure*}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/mag_scatter.eps}
\caption[magcut]{The 16, 50 and 84\% confidence intervals on $\kapparec$ minus $\kapparay$ as a function of the limiting $i$ band depth of the halo reconstruction. $\kapparec$ is given by $\sumkappah-\kappav$, where $\kappav$ is a constant such that $\left\langle\kapparec\right\rangle=0$. The majority of the constraining power comes from reconstructing halos with magnitudes between $18<i<24$}
\label{fig:magcut}
\end{figure}

%\subsubsection{Magnitude}
%\subsubsection{Distance}
%\subsubsection{Redshift}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Applying the Halo Model approximation to mock catalogs}
\label{sec:obsMstar+z}

Real attempts to reconstruct the convergence along a line of sight will not have direct access to the masses of dark matter halos, 
and will likely not have access to their spectroscopic redshift either. Instead these properties must be inferred from astrophysical
observables. In principle the only observables are astrometric positions, photometric colours and possibly spectra. In this section we
quantify the errors induced by inferring the halo mass and redshift from the observables. Much work has already focused on using
photometric colours to infer stellar mass \citep[\eg][]{xxx} and redshifts \citep[\eg][]{BPZ}, in line with these we shall use
stellar mass and photometric redshifts (with appropriate errors), as the observables that must be converted into an estimate
of $\kappax$. We will investigate two main sources of error: inferring halo mass given observed stellar mass and placing halos at the wrong redshift due to photometric redshift error.

We generate a stellar mass for each halo according to the stellar mass--halo mass relation of \citet{BehrooziEtal2010}. From this stellar mass we simulate 
an observed stellar mass by drawing a sample from $\pr(\log(M_{* \mathrm {obs}})|\log(M_{* \mathrm {true}}))$ which is given by a Gaussian of width $\sigma_{M_*}$ centred on $\log(M*_{\mathrm {true}})$. Where a spectroscopic redshift exists stellar masses can be estimated with typical uncertainties of 0.15 dex \citep{xxx}, however with photometric redshifts stellar mass uncertainties are typically three times as large \citep{xxx}; we use $\sigma_{M_*}=0.15$ for halos with a spectroscopic redshift and $\sigma_{M_*}=0.45$ otherwise. For photometric redshift errors we draw a redshift from $\pr(z_{\rm true}|z_{\rm obs})$ which we take as a Gaussian of width $0.1(1+z_{\rm spec})$ centred on $z_{\rm spec}$, where $z_{\rm spec}$ is the halo's true redshift in the \MS catalogue.

Given an uncertain stellar mass and redshift it is possible to infer a halo mass using the stellar mass--halo mass relation of \citet{BehrooziEtal2010}. This proceedure requires an inversion of the relation given in \citet{BehrooziEtal2010} and correctly inverting the relation's uncertainties requires care: the proceedure we use to do this is given in Appendix \ref{appendix:MSMH}. By drawing sample halo masses and redshifts, we can infer a sample $\kappah$ using the proceedure of Section \ref{model}; repeatedly drawing samples allows us to estimate P$(\kappah)$ for each reconstructed line of sight.

\subsection{Reconstructing $\kappa$ given a spectroscopic redshift for every object}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Width.eps}
\caption[magcut]{Could this be any uglier?}
\label{fig:reconwidths}
\end{figure}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Widthvshilberrt.eps}
\caption[magcut]{Could this be any uglier?}
\label{fig:widthsvsH}
\end{figure}

The best possible reconstruction of $\kappah$ corresponds to having a sepctroscopic redshift for every single object in our field. Observationally such a reconstruction would be prohibitively expensive in terms of telescope time, but we investigate this scenario as an ideal case. Reconstructing the lines of sight with perfect knowledge of the redshift but an uncertain stellar mass, we find that the width of $\Pr\left(\sumkappah \right)$ grows with the expectation value of $\sumkappah$; this is not surprising since the low $\sumkappah$ lines of sight are relatively empty and so there are few opportunities for uncertainties in the halo masses to propogate into $\sumkappah$ uncertainties. After applying the void correction the median reconstruction width is 0.0123; with 22 percent of lines of sight having a reconstruction width less than 0.01. 

\subsection{Reconstructing $\kappa$ from photometry alone}

Inferring the stellar mass of a galaxy from its magnitude and colours requires an estimate of how far away the galaxy is; without a spectroscopic redshift the the infered stellar mass is less precise. However, obtaining photometry has much lower observational cost; over the next few years several large area photometric surveys will reach 24th magnitude \citep{DES,EUCLID,LSST}, these will provide sufficient data to reconstruct lines of sight {\it without} additional observations. In principle the photometric redshift is correlated with the infered stellar mass, however we do not model this effect since the convergence from the outskirts of an individual halo is only weakly dependant on redshift at fixed mass: the redshift error is small effect on the recovered $\pr(\kappa)$ when compared to the effect of uncertain stellar masses.  With only photometric redshifts the uncertainty on $\sum\kapparec^{\rm halos}$ is much larger than the spectrocopic case and this propogates into a broader $\pr(\kappa)$, although the photometric reconstruction still typically produces a 1.4 fold improvement compared to the precision of the global P($\kappa$).

\subsection{Reconstructing $\kappa$ with partial spectroscopic coverage}

Whilst a fully photometric reconstruction provides useful constraints on $\pr(\kappa)$, targeted spectroscopy can provide addtional constraints upon the masses and redshifts of halos whose $\kappah$ contribution have the largest absolute uncertainty. Obtaining spectra of bright ($i<22$) objects is relatively fast with 8-m class telescopes; we find that if spectroscopic redhsifts were known for all $i<22$ galaxies in our field the reconstruction improves slightly upon the purely photometric reconstruction, although the improvement depends strongly upon the nature of the particular line of sight. Obtaining spectra for fainter objects would be considerably more expensive, but if spectroscopic redshifts could be obtained for all $i<23$ galaxies and all $i<24$ galaxies within 1 arcminute of the line of sight the $\pr(\kappa)$ would be almost as good as having complete spectroscopic coverage. High $\kappa$ lines of sight benefit the most from additional spectral coverage, since these LoS have the most uncertain $\kappah$. Consistent with our previous findings the lowest $\kappa$ lines of sight have the most constrained $\kappa$ PDFs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Testing for Systematic errors}
\begin{figure*}
\includegraphics[width=\textwidth]{figs/biascheck.eps}
\caption[magcut]{Is there evidence of a bias?}
\label{fig:where}
\end{figure*}

Whilst it is good to reconstruct $\kappa$ precisely it is vital that $\kappa$ is reconstructed accurately. A precise, inaccurate $\kappa$ estimator is worse than useless for cosmology. We test the accuracy of our reconstructed $\pr(\kappa)$ in the following way: for each line of sight we shift the reconstructed $\pr(\kappa)$ by the line of sight's raytraced $\kappa$ to give $\pr(\kappa-\kapparay)$. Since the $\pr(\kappa-\kapparay)$ for each line of sight is an independant estimator of zero, the PDFs can be combined according to

\be
\label{eq:bias}
\mathcal{P}_N=\prod_{i=1}^N \pr_i(\kappa-\kapparay)
\ee

We quantify the bias as the size of the deviation in the expectation value of $\mathcal{P}$ from zero. If the bias of $\mathcal{P}_N$ is typically smaller than the half-width of $\mathcal{P}_N$ our $\kappa$ estimators can be considered accurate. The number of useful time delay lines of sight can be approximated as the point at which the modulus of the bias and width of $\mathcal{P}_N$ are the same size.

%\todo{tom}{do}
%\subsection{Using the wrong M$_{\rm halo}$-M$_{*}$ relation}
\subsection{Selecting bias from a subset of lines of sight?}

First we test for systematic errors in the reconstruction of a randomly selected subset of samples. With the purely photometric reconstruction there is a small bias towards underestimating $\kappa$, the half-width and bias of $\mathcal{P}_{7}$ equalling 0.005. With targeted spectroscopic follow up this improves significantly, with the half-width and expectation value of $\mathcal{P}_{20}$ equalling 0.0026. With photometry alone systematics dominate after 7 randomly selected lenses, but with targetted follow-up upto 20 randomly selected lenses can be useful.

\subsubsection{Selecting only the lines of sight with tight $\pr(\kappax)$}
\label{sec:tightPDF}

Since lens monitoring campaigns are expensive, it is likely that only a subset of lenses will be observed. By pre-selecting the lenses with the most well constrained $\pr(\kappax)$, the cosmological value per lens can be increased, however this has the potential to induce a bias. It is probable that only photometry will be available at the time of lens selection (although spectroscopic follow-up might be conducted at a later date). We mimik such a selection by drawing lines of sight only from those in the lowest third of $\sigmak$ given a photomtric reconstruction of their fields. We find that selecting the most tightly constrained lines of sight {\it decreases} the bias - our reconstruction is most succesful for the lowest $\kappa$ lines of sight. Even with photometry alone the bias is only significant after $\sim$100 lenses have been combined, at which point the width of $\mathcal{P}_{100}$ is 0.001. With a targeted spectroscopic follow-up of the selected lines of sight there is only modest improvement, since the best constrained lines of sight are the most empty, but it is the high-$\kappa$ lines of sight that benefit the most from spectroscopy. Photometry of the field is sufficient to adequately select the best lines of sight for cosmology - and doing so greatly increases both the precision and accuracy of the cosmological constraints per lens.

\subsubsection{Selecting only high shear lines of sight}
\todo{phil}{Write up why lenses are likely to be gamma biased}
\notes{The uncertainties from modeling a strong lens system depends on the comfiguration of the source images. With only two point images ofthe source the lens slope and mass are degenerate; the mass-slope degeneracy\citep{mass-slope degeneracy} cite saha?. Where lensed arcs or four point images are present the mass-slope degeneracy can be broken and cosmology can be extracted, \citep{suyu2012a}. The detectability of arcs depend on the source, but the presence of four images (so called quads) depend on the shear of the lens model - a high shear is needed to produce a quad. The shear is almost certainly dominated by the lens model itself, but it is possible that quads are biased towards high external shear.} 

By selecting only lines of sight with an external shear of $\gamma>0.03$ we can test the effect of shear selection. We find that in all cases $\kappa$ is underestimated at the 0.006 level; roughly corresponding to the precision achieved by combining five lenses. Since our model does not include shear constraints it is not surprising that selecting based on shear can induce a bias. A more sophisticated model that includes the shear recovered from the lens modelling may not be susceptable to this bias. The toy model of this section ($\gamma>0.03$) is likely to be a much stronger selection than reality, but it is worth noting that the reconstruction proceedure will be biased if lens selection functions are extreme.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\section{Improving precision by including additional information}
%\notes{placeholder for shear}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discuss}

We have shown that reconstructing the matter due to halos along any line of sight can give meaningful and unbiased constraints on the external convergence along that line of sight. The total convergence along a line of sight is strongly correlated with the reconstructed $\kappah$. However since our model ignores voids and assumes all halos follow a spherical truncated-NFW profile our model does not include all of the relevant physics, hence the width of our resulting $\pr(\kappax)$ is still typically $\sim$0.01 for any given lightcone, even with a perfect knowledge of every halo's virial mass and redshift. To make further progress a more advanced treatment of both voids and halos will be necessary. Interestingly, we have found that the most empty lines of sight can be reconstructed with the most precision. $\kappax$ for empty lines of sight have little contributions from halos and a large contribution from voids; since they have the tightest PDFs after the reconstruction it seems that our model's biggest uncertainties are driven by naively reconstructing halos rather than neglecting voids. With a photometric reconstruction of the field there is only a small broadening compared to the perfect knowledge reconstruction; it seems that deviations from sphericity and dark matter clumping within the main halo are the dominant uncertainies rather than uncertainties in the halo mass. Inferring halo ellipticity and dark matter clumping will likely always remain a difficulty for line of sight reconstruction; as Figures \ref{fig:magcut} and \ref{fig:width2} show observing deeper than 24th magnitude does not signifcantly help the reconstruction. Because our reconstruction is mostly limited by the model, spectroscopic coverage can only provide a modest improvement to the reconstruction and at significant observational cost.

For a small fraction of lines of sight, $\pr(\kappax)$ remains very broad even after applying our reconstruction; these lines of sight are typically the most overdense lines of sight in the universe. For time-delay cosmography the most observationally expensive task is the lightcurve monitoring, whilst making photometric observations of a 4$\times$4 arcminute patch of sky survey down to 24th magnitude is a relatively cheap. We have shown that with a single epoch observation of the region around a strong lens it is possible to infer $\pr(\kappax)$. If a line of sight has a broad $\pr(\kappax)$ it can be rejected {\it before} the investment of longterm lightcurve monitoring.

The method we have outlined can also be used to estimate the external shear
along a line of sight. Shear is an observable that can be extracted from
strong lens modelling, however there is a degeneracy between internal and
external shear. Progress has been made in disentangelling external and
internal shear \citep[\eg][]{xxx} but there are still significant
uncertainties: \citet{WongEtal2011} attempted to match the shear from strong
lens models with a reconstruction of the local lens group environment, but
found a tension between the strong lens model and the reconstruction of the
environment. Since \citet{WongEtal2011} only reconstructed the local lens
group, rather than the full line of sight contribution, it is unclear whether
the external shear from lens models can be reconciled with a line of sight
reconstruction. {\it If} external shear can be measured, it provides an
additional constraint on which of the Millenium Simulation lines of sight are
similar to the reconstructed line of sight. \citet{SuyuEtal2012} found that
for RXJ1131 combining shear constriants with galaxy number count overdensity,
gave a significantly different $\pr(\kappax|\gamma,N_{45})$ copmpared to the
PDFfrom number count overdensity alone, $\pr(\kappax|N_{45})$. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
\label{sec:conclude}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgments}
 
TC thanks Vasily Belokurov for guidance and discussions.
We thank Risa Wechsler and Peter Behroozi for useful discussions and 
suggestions.
\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Inferring $\Mhalo$ given a noisy measurement of $\Mstarobs$}
\label{appendix:MSMH}

\todo{Phil}{Check that what's written is correct}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:

% bubble -f paper-lcr.tex references.bib 
% \input{paper-lcr.bbl}

% \bibliographystyle{apj}
% \bibliography{references}

\input{references.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{lastpage}
\bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
