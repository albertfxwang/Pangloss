%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pangloss: Testing the reconstruction method
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

\voffset=-0.6in

% Packages:
\input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}

% Macros:
\input{macros.tex}
\input{addresses.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Line of Sight Mass Reconstruction]
{Reconstructing the Lensing Mass in the Universe \\
from Photometric Catalogue Data}
    
\author[Collett \etal]{%
  Thomas~E.~Collett$^{1}$\thanks{\collettemail},
  Philip~J.~Marshall$^{2}$,
  Matthew~W.~Auger$^{1}$,
  Stefan~Hilbert$^{3}$,
\newauthor{%
  Sherry~H.~Suyu$^{4}$,
  Zachary~Greene$^{4}$,
  Tommaso~Treu$^{4}$\thanks{\packard},}
\newauthor{%
  Christopher~D.~Fassnacht$^{5}$,
  L\'eon~V.~E.~Koopmans$^{6}$,
  Roger~D.~Blandford$^{3}$} 
  \medskip\\
  $^1$\ioa\\
  $^2$\oxford\\
  $^3$\kipac\\
  $^4$\ucsb\\
  $^5$\davis\\
  $^6$\kapteyn
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2012}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract} 

High precision cosmological distance measurements towards individual objects
such as time delay gravitational lenses or type Ia supernovae are affected by
weak lensing perturbations by galaxies and groups along the line of sight.
Such massive structures contribute an ``external convergence'' $\kappax$ that
in time delay gravitational lenses can dominate the uncertainty in the inferred distances.  We
characterise this uncertainty by marginalising over a probability density
function for $\kappax$: here, we investigate the use of a simple halo model to
estimate $\pr(\kappax|\data)$ given noisy estimates of the photometric redshift
and stellar mass of galaxies observed in optical imaging surveys of the field
in question. We use mock catalogues from the Millennium Simulation, and compare
our reconstructed $\pr(\kappax|\data)$ to ray-traced $\kappax$ truth values: 
taking into account realistic uncertainties on redshift and stellar masses, we
typically find that the reconstruction yields a factor of 2 improvement in precision of
over the global $\pr(\kappax)$. For any given line of sight the
convergence estimate can be made before the investment of expensive follow-up
observations. We find that the lowest $\kappax$ lines of sight have the best constrained 
$\pr(\kappax)$ after applying our reconstruction. We find that selecting systems by the precision with which
$\kappax$ can be estimated leads to a sample of unbiased
time delay distance estimates with 1\% uncertainties due to external convergence effects.
Photometric data alone is sufficient to pre-select the best lenses and can be done
before investment in lightcurve monitoring. Preferentially selecting lines of
sight with high external shear (as might happen in an assembled sample of
quadruply-imaged time delay lenses) produces time-delay distance estimates with
typical uncertainties of 1.5\% and biases of 0.3\%. We suggest areas for the improvement of this general
analysis framework that should allow yet more accurate cosmological inferences
to be made.

\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing   --
  methods: statistical    --
  galaxies: halos         --
  galaxies: mass function  --
  cosmology: observations
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:intro}

Every distant object we observe has had its apparent shape distorted,
and size and total brightness magnified (or demagnified) by a compound
weak gravitational lens constructed from all the mass distributed
between us and it. As \citet{Vale+White2003} and \citet{HilbertEtal2007}
showed, there are no empty lines of sight through our universe. This
fact makes gravitational lensing a potentially important source of
systematic error for any estimate of luminosity (or distance); this 
issue has been 
raised for \eg type Ia supernovae by
\citet[][]{Holz+Wald1998,Holz+Linder2005}, for gamma ray bursts by
\citet[][]{Oguri+Takahashi2006,Wang+Dai2011},  and for high redshift
galaxies by \citet{BradacEtal2009}, among others. 

Along lines of sight containing strong gravitational lenses, the
perturbative effects of line of sight mass structure have been found to
be particularly important, with foreground and background structures
having a significant effect on the inferred lensing cross-section
\citep[\eg][]{WongEtal2012} and distance ratios
\citep[][]{DalalEtal2005}. Indeed, \citet{SuyuEtal2010} found that in
time delay lens cosmography the so-called ``external convergence''
$\kappax$ due to mass structures along the (unusually over-dense) line
of sight to the quadruply-imaged radio source B1608$+$656 was the
dominant source of uncertainty in their 5\% measurement of the time delay distance. 
Whilst it is rare for three galaxies to line up well enough for both of
the background sources to be strongly lensed \citep{GavazziEtal2008,CollettEtal2012a}, 
the large size of dark matter halos makes partial alignments -- such that they
act as perturbing weak lenses --  a near certainty. The large scale of the
perturbers means the external lensing perturbations can be approximated
by a quadrupole lens characterised only by external convergence and shear.
The external shear can potentially be recovered in the
mass-modelling of the lens, but the convergence is undetectable from the
image positions, shapes and relative fluxes; this is the famous {\emph{ 
mass sheet-degeneracy}} \citep[see e.g.][for details]{FalcoEtal1985}.



When inferring global quantities
(such as the cosmological parameters), combining the results from a
large number of independent objects will tend to reduce the uncertainty
due to external convergence \citep[\eg][]{Holz+Linder2005}, unless the lines of sight are not representative of the global population. If the line of sight selection function is not correctly modelled some residual systematic error will
remain even as the statistical uncertainty decreases. A selection function may be introduced either at the object
detection stage, or later on when making decisions about which objects
to study further. Large samples
of lenses are expected to be discovered in the next decade in
ground-based optical imaging surveys \citep{Oguri+Marshall2010}: both
the detectability of these lenses,  and the selection of sub-samples of
them for further observation, could be sensitive to the external
convergence. 

Several attempts have been made to do better than simply constructing a
large sample of objects, and averaging over the resulting convergence
distribution. The weak lensing effect can be detected observationally 
by measuring the
small distortions it induces on the images of many background galaxies
in the field \citep[see e.g.][for a review]{Schneider2006}. 
\citet{NakajimaEtal2009} used deep HST imaging to infer $\kappax=0.17\pm0.06$ from weak lensing measurements; this measurement was used in the time delay distance
measurement of \citet{FadelyEtal2009}. A precise weak lensing estimate of $\kappax$ can only be made if the number density of of weakly lensed, measurable galaxies is high.

In order to make more precise estimates of the convergence at a given
sky position, we need more information.   There have been some attempts
to reconstruct the local and line of sight mass distribution in strong
lens fields in some detail, based on photometric and spectroscopic
surveys of the galaxies nearby. These efforts have focused on  detecting
galaxy groups, ascertaining the visible galaxies' membership of those
groups, and assigning mass to the group and galaxy halos in order to
predict the external shear apparently required by the strong lens
models. Surveys by
\citet{Fassnacht+Lubin2002,AugerEtal2007,WilliamsEtal2006,MomchevaEtal2006}
all found groups of galaxies both hosting, and lying  along the line of
sight to, known gravitational lenses. Initial estimates of the effect of
these structures suggested the importance of assigning mass to both
galaxy and group halos, and to allowing for significant uncertainty in
the centroids of group halos. 

In order to propagate the effect of line-of-sight perturbations into 
uncertainties on time-delay distances we require the probability density function (PDF) for the external convergence
given our available data $\data$, $\Pr(\xkappa|\data)$
% PHIL's REVIEWS OF THE LITRATURE
\comments{\citet{GunnarssonEtal2006} investigated a related PDF,  for the
magnification, using a galaxy halo model. Applying empirical galaxy
scaling relations both to simulate mock catalogues and then to reconstruct
the line of sight mass distribution. While they did not explore highly
over-dense lines of sight, or the impact of groups and clusters, they
found that under their simplifying assumptions, the dispersion in
apparent source brightness due to lensing magnification could be reduced
by a factor of two.
%
\citet{WongEtal2011} estimated the PDF for the external shear,
$\Pr(\gammax|\data)$ from their survey data, running similar Monte Carlo
reconstructions of the mass in nine lens fields based on
\citeauthor{WilliamsEtal2006} and \citeauthor{MomchevaEtal2006}'s
photometric and spectroscopic measurements of galaxies close to the line
of sight. They then  compared the resulting predicted shear
distributions with the external shear demanded by the strong lens model.
Their reconstructions showed most of the shear to have been generated by
bright galaxies within 2~arcminutes of the lens, and that both line of
sight structures and the group of galaxies in each lens plane contribute
significant proportions of the shear. They found significant
discrepancies between the lens model shear and the Monte Carlo
predictions, but were unable to distinguish between the environment
modelling and the strong lens modelling as the cause of these
discrepancies.
%
\citet{KarpenkaEtal2012} used a halo model to predict deterministically 
the magnification due to
galaxies along the line of sight to type Ia supernovae, and inferred the
parameters of scaling relations between light and mass in these galaxies
from hundreds of supernova lightcone simultaneously. Following
\citet{JonssonEtal2010}, they subtract off the mean convergence to ensure that
the universal mass budget is balanced, and compare models where the halos are
all have either truncated singular isothermal profiles, or 
NFW profiles. Both groups were able to 
detect lensing effects in the supernova data this way.
}
% TOM's DISTILLING OF SAID REVIEWS.
Previous investigation of line-of-sight perturbations have focused on 
magnification and shear.\citet{GunnarssonEtal2006} used a galaxy halo model combined with simple scaling relations to reconstruct
the line of sight mass distribution and found that the dispersion in
apparent source brightness due to lensing magnification could be reduced
by a factor of two. Conversely \citet{KarpenkaEtal2012} used the brightness dispersion in type Ia supernovae to infer the parameters of both their galaxy halo model and mass-to-light scaling relation. Both \citeauthor{KarpenkaEtal2012} and \citet{JonssonEtal2010} were able to 
detect lensing effects in the supernova data this way.
%
\citet{WongEtal2011} estimated the PDF for the external shear,
$\Pr(\gammax|\data)$ from their survey data,
\citep{WilliamsEtal2006;MomchevaEtal2006} of galaxies close to the line
of sight. Comparing the predicted shear
distributions with the external shear demanded by the strong lens model 
they found significant
discrepancies, but were unable to distinguish between the environment
modelling and the strong lens modelling as the cause of these
discrepancies. \citeauthor{WongEtal2011} also found that both line of
sight structures and the group of galaxies in each lens plane contribute
significant proportions of the shear. 

Large numerical simulations have been used to
predict, from first principles, the distribution of likely external
shears and convergences along various lines of sight, including those
containing strong lens systems.  \citet{Holder+Schechter2003} and
\citet{DalalEtal2005} carried out ray-tracing calculations in N-body
simulations to estimate the distribution of external shear values. 
\citet{HilbertEtal2009} performed similar ray-tracing experiments
through the Millennium Simulation \citep{SpringelEtal2005}, generating a
predicted $\kappax$ at every position in a simulated sky.
\citet{HilbertEtal2009} found that \MS lines of sight with strong lenses
were not biased towards high $\kappax$, although selection functions for
discovering or using particular samples of strong lenses were not taken
into account.

The \MS results have been used to analyse real observations as well. 
\citet{SuyuEtal2010} selected \MS lines of sight by their apparent
galaxy over-density, in a 45 arcsec radius aperture down to $i < 24.5$,
to match the observed over-density towards the time delay lens
B1608$+$656 \citep{FassnachtEtal2011}.  The resulting distribution of
$\kappax$ values from the ray-tracing was taken to be an estimate of 
$\Pr(\kappax)$, which was then marginalised over when inferring the time
delay distance in this system. A similar procedure was used in \citet{SuyuEtal2012b}.
% B1608$+$656 is indeed a high $\kappax$
% line of sight, but it does not reside in a massive cluster environment.
In a companion paper to this one, Greene et al. (submitted) investigate
improvements to this method by weighting the galaxy counts by galaxy
mass, and perpendicular distance to the line of sight, again using the
\MS mock catalogues and their associated $\kappax$ values to construct
$\Pr(\kappax|\data)$. For the most over-dense lines of sight the
Green et al. results  show a $\sim$20\% improvement over
number counts alone, but little improvement for less dense lines.


In this paper, we combine the halo model reconstruction approach of
\citeauthor{GunnarssonEtal2006}, \citeauthor{JonssonEtal2010}, 
\citeauthor{WongEtal2011} and others, with the
idea of calibrating to simulations from \citeauthor{SuyuEtal2010}.
Taking the $\kappax$ values from
\citeauthor{HilbertEtal2009}'s ray-tracing calculations as the ``truth''
that we have to recover, we use the \MS mock galaxy catalogues first to
{\it calibrate} the reconstruction, and account for unseen mass and
voids, and then to {\it test} the accuracy of the line of sight mass
reconstruction under this assumption. Probabilistically assigning mass
and redshift to every observed galaxy in a given observed field, we
generate Monte Carlo sample line of sight mass distributions, and so
construct the PDF $\Pr(\kappax|\data)$ for that field. We then emulate
the combination of many such PDFs to quantify the residual biases that
would be translated to the global (including cosmological) parameters.
In doing so, we aim to answer the following questions: 

\begin{itemize}

\item Faint galaxies, filaments and dark structures will not appear in
any photometric object catalogue, but they will contribute convergence at
some level. How much of the total convergence comes from visible
galaxies, and how much effect do dark structures and voids have? 

\item Can the true convergence be recovered from a calibrated halo model
reconstruction? What scatter and residual bias are induced by the
reconstruction process, and how might these be reduced in the future? 

\item We have some choices to make when planning follow-up observations
of interesting sight-lines. How should we select objects to achieve the
highest accuracy convergence reconstruction? Can such a selection be
made robustly, using the reconstruction results?

\end{itemize}


This paper is organized as follows. We review the relevant gravitational
lensing theory in~\Sref{sec:theory}, and the Millennium Simulation
ray-traced convergences and mock catalogues in \Sref{sec:MS}, before
introducing our simple reconstruction  model in \Sref{sec:model}. We
then test this model in two phases: first, in \Sref{sec:knownMh+z}, with
known redshift and halo mass for every galaxy in a lens field, in order
to quantify the irreducible uncertainty due to unseen mass, and second,
in \Sref{sec:obsMstar+z}, with realistic observational uncertainties on
the observed galaxies' stellar masses and redshifts. In
\Sref{sec:biases} we investigate the potential systematic error induced
by selecting a subset of sightlines. We discuss our results in
\Sref{sec:discuss} before concluding in \Sref{sec:conclude}.

Throughout this paper magnitudes are given in the AB system and
we adopt the Millennium Simulation's ``concordance'' parameters for our reference cosmology, \ie
$h=0.73$, $\Omega_m=0.25$ and $\Omega_\Lambda=0.75$, where the symbols indicate
the Hubble Constant in units of 100 km s$^{-1}$ Mpc$^{-1}$ and the matter and
dark energy density of the Universe in units of the critical density.
.%\citep[e.g.\ ][]{KomEtal09}.



\begin{figure*}
\includegraphics[width=\textwidth]{figs/viewofalightcone.eps}
\caption[magcut]{Four different views of a slightly over-dense \MS line
of sight, with a $\kappax$ of 0.03. 
{\it Top row, left:} The positions of galaxies projected on the sky. The area
of the circles is proportional to observed $i$-band flux; the brightest
object shown has an $i$ magnitude of 17.7. 
{\it Top row, centre:} The angular sizes of halos projected on the sky.
Red and blue regions lie within the NFW scale radius and virial radius
of each halo, respectively. There are essentially no empty lightcones. 
{\it Top row, right:} The individual $\kappax$ contributions of
each halo, assuming a \citet{BMO} profile and the \citet{Neto2007}
mass-concentration relation. Comparison of
this panel and the centre panel reveals the relative importance of
proximity to the line of sight.
{\it Bottom:} A view along the redshift axis, showing only halos with
$|x|<0.3$ arcmin. The area of the points is proportional to each halo's
mass: the most massive halo shown has $1.6\times10^{12}\Msun$. The
optical axis is shown by the dashed line, while the dotted lines mark
the lens and source planes for a B1608-like strong lens.}
\label{fig:lightcone}
\end{figure*}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical Background}
\label{sec:theory}
\comments{
Convergence, or Ricci focusing, occurs when a gravitational lens focuses
the rays in a given bundle. This focusing can cause distant objects to
appear brighter, and larger than they would if the lens were removed.
The convergence from an isolated mass sheet is the ratio of the projected surface
mass density ($\Sigma$) \devided by the
critical surface mass density at the redshift of the mass sheet
($\Sigma_{\rm cr}$),
\be
\kappax= \frac {\Sigma}
                              {\Sigma_{\rm cr}(\zd,\zs)}
\ee
where 
\be 
\label{eq:sigcrit} 
\Sigma_{\rm cr}(\zd,\zs) \equiv \frac{c^2 D_{\rm os}}{4 \pi G D_{\rm od} D_{\rm ds}}.
\ee
and the $D$'s are the angular diameter distances between the objects
referred to in the subscripts: o is the observer, d is the deflector and
s is the source. If the surface mass density of the sheet exceeds
$\Sigma_{\rm cr}$, multiple images of the source can occur, otherwise
only one image will be observed, although that image will still be
perturbed relative to the unlensed case.


Strong lensing occurs when a massive object and background source are almost perfectly
aligned along a line of sight. The light from the background source is deflected by the
lens galaxy; this deflection allows multiple images of the background source to form
at stationary points of the time delay function. For an isolated lens, the time delay
function can be calculated from
\be \label{eq:T} 
\Delta t(\bmath{\theta},\bmath{\beta}) = \frac {1}{c} \frac{D_{\rm od} D_{\rm os}}{D_{\rm ds}} (1+z_{\rm d})\, \phi(\bmath{\theta},\bmath{\beta}),
\ee
where $\bmath{\theta}$ is the observed source position, $\bmath{\beta}$ is the 
unlensed source position, $z_{\rm d}$ is the redshift of the lens, $\phi(\bmath{\theta},\bmath{\beta})$ is
the Fermat potential. The Fermat potential is given by
\be \label{eq:FP}
\phi(\bmath{\theta},\bmath{\beta})\equiv \left[\frac{(\bmath{\theta}-\bmath{\beta})^2}{2}-\psi(\bmath{\theta}) \right], 
\ee
where $\psi(\bmath{\theta})$ is the lens potential, derived from the projected dimensionless
surface mass density, $\kappa(\bmath{\theta})$, by 
\be \label{eq:psikappa}
\kappa(\bmath{\theta})=\frac{1}{2}\nabla^2\psi(\bmath{\theta}).
\ee
}

\new{
In strong lens systems where the source is time variable, the images do not 
vary simultaneously; the optical path length for each image is different due
to relativistic and geometric effects. The difference in optical path length
causes a time-delay between the light curves of each image. \citeauthor{FalcoEtal1985}
showed that the presence of additional matter (in the form of a mass-sheet)
along the line of sight has no observable effect except to rescale the time-delays.
As such, it is necessary to include $\kappax$ in the lens modelling, if
cosmological parameters are to be estimated accurately and precisely from
observed time delays \citep{SuyuEtal2010}. 
}

If there is external convergence present that is not included in the
lens modelling, then the time delay distance -- inferred assuming $\kappax
= 0$ -- will be $(1-\kappax)$ more than the true value of $\Dt$:
\be 
\label{eq:MassSheet:Dtbias}
\Dt^{\rm{true}}=\frac{\Dt^{{\kappax = 0}}}{1-\kappax}.
\ee

We can hence estimate the true distance {\it only} if we have additional
knowledge of $\kappax$. Since $\kappax$ is typically small the absolute
uncertainty on the estimate of $\kappax$ corresponds to the fractional
uncertainty with which time-delay distances can be \infered.

Mass distributions that are
physically associated with the lens galaxy will affect the stellar dynamics of
the lens galaxy, so that dynamical observations can break the internal
mass-sheet degeneracy by providing an additional estimate of the lens galaxy's
mass \citep[e.g.,][]{SuyuEtal2010}. In this work our aim is to quantify the
lensing effect of massive objects, regardless of their position along the line
of sight.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Millennium Simulation}
\label{sec:MS}

In order to test the accuracy of our convergence estimates, we need to
know the true convergence for each line of sight. We cannot use  real
lines of sight for this,  but must use simulated lines of sight instead.
In this section we briefly review the Millennium Simulation, the ray
tracing calculations that have been carried out in it, and the mock
galaxy catalogues that have been produced.

The \MS \citep{SpringelEtal2005} is a cosmological N-body simulation of
Dark Matter structures in a cubic region approximately 680~Mpc in
co-moving size, followed from redshift 127 to the present day. With an
approximate halo mass resolution of $2\times10^{10}{\rm M}_{\odot}$
(corresponding approximately to a galaxy with luminosity $0.1L^{*}$), it
provides a detailed prediction for the distribution of dark structures
present in the Universe, under the assumptions of the $\Lambda$CDM model
of hierarchical structure formation, cosmological densities as given at
the end of \Sref{sec:intro}, and $\sigma_8 = 0.9$.
Galaxy properties,
such as stellar masses, luminosities and colours, were assigned to the
simulated halos according to a semi-analytic model for galaxy formation
\citep{DeLucia+Blaizot2007}: the resulting predictions for the galaxy
luminosity function and correlation function match the observational
data very well.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Convergence from Ray Tracing}
\label{sec:MS:raytracing}

\citet{HilbertEtal2009} calculated the lensing convergence using the
``lightcone'' dark matter only 
output of the \MS, providing 1.7 degree square 
mock sky maps of this
quantity. In this process, the dark matter density from the simulation
was projected onto a set of lens planes at discrete redshifts,
adaptively gridded and smoothed, and then the second derivatives of the 
lensing potential required for the components of the magnification
matrix were computed using a multiple lens plane ray tracing algorithm.
The first order approximation to this algorithm \citep[equation 17
of][]{HilbertEtal2009} gives the total convergence at a given sky
position~$\bmath{\theta}$ as the simple summation of the surface density
in each lens plane, weighted by the inverse critical surface density
$\Sigma_{\rm cr}$ for that plane's redshift:
\be
\kappax(\bmath{\theta}) = \sum_i \frac{\Sigma_i(\bmath{\theta})}
                                     {\Sigma_{\rm cr}(z_i,\zs)}.
\ee
This approximation was found to be accurate to a few percent or better
in $\kappax$, even on 30 arcsecond scales.

To define a test line of sight, we draw a random sky position from
within the convergence maps, bilinearly interpolate between the pixels
of the map, and store the result as the ``true'' convergence for that
line of sight, $\kappax^{\rm true}$. 

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Mock Photometric Galaxy Catalogues}
\label{sec:MS:mocks}

We construct mock photometric galaxy catalogues by selecting all \MS
galaxies within a circular aperture of a given angular radius centred on
the line of sight position, with apparent $i$-band magnitude brighter
than a given limit. The parent catalogue, from \citet{HilbertEtal2011},
contains galaxy positions and magnitudes, all of which include lensing
effects (deflections and magnifications). We also have access to the
underlying galaxy halo masses and redshifts, which we will use to
calibrate the reconstruction, and also to explore any sources of bias
and scatter. Since the true convergence is that of only the dark matter,
we focus on reconstructing the dark matter halos alone. Our model for
doing this is outlined in the next section. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Estimating Convergence: The Halo Model Approximation}
\label{sec:model}

We require a method for estimating the
convergence at any point on the sky, given a catalogue of observed
galaxy properties such as positions, brightnesses, colours, and
possibly stellar masses and redshifts, for every galaxy in the field of
the lens, down to some magnitude limit. Since we cannot observe the
surface mass density of each halo directly, we need some way of
estimating the mass of each halo in the catalogue, so that we can compute
its contribution to the total $\kappax$ along the line of sight \citep[as
in \eg][]{GunnarssonEtal2006,WongEtal2011,KarpenkaEtal2012}. 
This mass assignment recipe
will be uncertain, but can be calibrated with cosmological simulations, which
represent a significant additional source of information to what is present in
the data.

Transforming an observed photometric galaxy catalogue into a 
catalogue of halo masses, positions, and redshifts, will enable us to
attempt a reconstruction of the convergence induced by every halo near a
line of sight. \new{We also need to account for the convergence due to dark structures and
the divergence due to voids; we do not model voids or dark structures, but their
effects are included statistically by calibration the the convergence in halos,
$\kappah$, against the ray-traced convergence, $\kappax$, for \MS lines of sight.}


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Halos}
\label{sec:model:halos}

Cosmological dark matter simulations have shown that dark matter
halos are well-approximated by NFW profiles \citep{NFW}, with a density
profile given by
\be\label{eq:rhonfw}
\rho(r) = 
\frac{\rho_0}{\left(r/r_{s}\right)
\left(1+r/r_{s}\right)^{2}},
\ee
where $r_{s}$ is a characteristic radius of the cluster, representing where
the density slope transitions from $r^{-1}$ to $r^{-3}$. This radius is related
to the virial radius of the halo by $r_{s}~=~r_{200}/c$, where $r_{200}$ is the radius at 
which 
\be
\rho(r_{200}) = 200\rho_{{\mathrm{crit}}}(z), \text{ where } \rho_{\mathrm{crit}}(z) \equiv \frac{3H^{2}(z)}{8\pi G}
\ee
and $c$ is the concentration parameter, which can be estimated from the halo's mass,
using a mass--concentration relation. Typically more massive halos are less concentrated,
but there is some scatter; we use the relation of \citet{Neto2007} to estimate $c$
from the mass enclosed within $r_{200}$, which we denote as $M_{200}$. We find our results do not change if the \citet{MaccioEtal2008} Mass--concentration relation is used instead. The best fit relation of \citet{Neto2007} is given by
\be
c_{200} = 4.67 (M_{200}/10^{14} h^{-1} \Msun)^{-0.11}.
\ee

$\rho_0$ is calculated from the critical density and concentration parameter:
\be
\rho_0 = \rho_{\mathrm{crit}}(z)\frac{200}{3}\frac{c^{3}}{\ln(1+c)-c/(1+c)}.
\ee

If one integrates the density profile of an NFW profile out to infinite
radius, the total mass diverges. Similarly, if the universe is
homogeneously populated with NFW halos, the projected surface mass along
any line of sight will also be divergent.\footnote{At large radius,
$\Sigma_{\rm nfw} \propto R^{-2}$, but the differential number of halos
centred within an annulus of width $\dee R$ is given by $\dee N_{\rm
annulus} \propto R \dee R$, so  $\Sigma_{\rm total} \propto
\int_{0}^{\infty} R^{-1} \dee R$, which diverges logarithmically} Since
infinite mass is unphysical, the profile must be truncated at some
point. Several truncation profiles have been suggested
\citep[e.g][]{BMO}, but beyond several virial radii, the amount of
matter associated with a halo is likely to be low. In this work we
assume the truncated NFW profile
\be\label{eq:bmoprofile}
\rho(r) = 
\frac{\rho_{\rm NFW} (r)}{1+\left(r/r_{t}\right)^2},
\ee
which is the same as the NFW profile in the limit that the truncation
radius, $r_t$ goes to infinity. We use a truncation radius of five times
the virial radius, but our results are robust for any choice of $r_t>2
\times r_{200}$. The formula for the projected surface mass density 
$\Sigma(D_{od}\theta)$ for this
mass profile is given in \citet{BMO}. 

Each halo in our catalogue then contributes to
the line of sight convergence by
\be
\label{eq:kappai}
\kappa_i =\Sigma_{i}/\Sigma_{\mathrm{cr}}(z_i,\zs),
\ee
where the critical surface density was defined in \Eref{eq:sigcrit}.
Following the first order approximation of \citet{HilbertEtal2009}
outlined in \Sref{sec:MS} above, we compute 
the total convergence from all the halos along the line
of sight using
\be 
\label{eq:kappasummu}
\kappah = \sum_{i} \kappa_i.
\ee
\notes{Using the Born approximation, we approximate light rays as straight.}

To estimate a halo's contribution to $\kappah$ we must first know the
halo's mass. For the sightlines of the \MS, halo masses are
known, but for  real lines of sight the halo masses have to be \infered
from whatever data is available. 
In this work we investigate the use of the empirical stellar mass --
halo mass relation for this purpose. The primary advantage of this
approach is that it is a simple, ``one size fits all'' relation that can
be applied regardless of the stellar mass observed. We discuss
additional observables that could be used to improve the precision of
the halo mass inference in \Sref{sec:discuss} below. 

We use the relation of \citet{BehrooziEtal2010} to infer halo masses
from stellar masses; the details of this \proceedure are outlined in 
\Aref{appendix:MSMH}. Given an uncertain stellar mass and redshift for
each galaxy in the  catalogue, we draw a sample halo mass from the PDF
that describes this uncertainty  (\Eref{eq:mhalo-mstar})  and use
\Eref{eq:kappai} to compute its contribution to the convergence,
$\kappa_i$; this can be done for all the halos along a specific line of sight
and summed to give a sample value of $\kappah$;  repeatedly applying
this \proceedure allows us to build up a histogram of $\kappah$ values
consistent with the data, and hence characterize $\pr(\kappah|\data)$. 

This PDF contains a hidden assumption of an uninformative prior PDF for
$\kappah$ -- in the case of infinitely poorly measured stellar masses and
redshifts, $\pr(\kappah|\data)$ will have very long tails corresponding to
very overdense sightlines that we do not believe exist. The resolution of this
is to divide out the effective prior PDF that was applied during the halo mass
estimation process (which is broad, and hence close to uniform), and apply an
additional prior on $\kappah$, given by the global underlying $\kappah$
distribution from the simulation. In the limiting  case of very poor
photometric data, $\pr(\kappah|\data)$ then defaults to this distribution.

% \todo{All}{Discuss this. It ties us to the simulation, but only weakly. Is the
% argument about poor data valid? Tom?}

% TEC: yes it's valid. It only really ties us to the halo mass function of the simulation. It's probably tied at the same level as the "global P(\kappa) as derived from Stefan's ray-tracing"


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Accounting for voids, filaments and other dark structures}
\label{sec:model:voids}

While halos contribute a positive convergence to $\kappax$, voids contribute
a negative convergence. When a ray bundle passes through a  region of space
that is less dense than $\rho_{\rm mean}(z)$ the rays are de-focused\footnote{In
principle, the convergence caused by halos is also caused by the overdensity,
but we neglect this effect since halos are typically much more dense than the
intergalactic medium}. Whilst the  full ray-traced solution takes into account
the effect of voids, our reconstruction cannot -- the halo catalogue does not
include voids. \new{In principle the absence of galaxies implies something about
the presence a void, but we do not attempt to use this information}. Neglecting voids
would lead to a heavily biased estimate of $\kappax$. Moreover, the halos in 
the model only add mass to the background density, and that background density
already accounts for all the mass in the Universe! In order to make voids
negative relative to the mean density, we must subtract a significant smooth
mass component. The problem is that we do not have a good model for the
density structure of that smooth component. 

The solution we present here is to calibrate the relationship between halo
convergence $\kappah$ and underlying convergence $\kappax$ (as calculated
during full ray tracing) using the simulations themselves.
The halo modelling \proceedure outlined in \Sref{sec:model:halos} allows 
us to estimate 
the convergence due to halos given observations of 
mass, redshift and position,
$\pr(\kappah|\mathcal{D})$, but what we are interested in is the total convergence
along the line of sight $\pr(\kappax|\mathcal{D})$. We can obtain this by
considering the expression:
\begin{equation}
\Pr(\kappax|\mathcal{D}) = \int \dee\kappah 
   \Pr(\kappax|\kappah) \Pr(\kappah|\mathcal{D})
\label{eq:kappaconv}   
\end{equation}
The first term in the integrand relates the convergence due to model halos,
$\kappah$, to the true convergence, $\kappax$. This conditional distribution
can be constructed from the Millennium Simulation catalogues, by computing
$\kappah$ for each selected line of sight using the true values of the halo
parameters,  and accumulating $\kappah$ and $\kappax$ along a large number of
such lines of
sight to  characterize $\Pr(\kappax|\kappah)$.
For any given line of sight we can then estimate
$\pr(\kappah|\data)$ as described above, and then
multiply it by $\Pr(\kappax|\kappah)$ and integrate out the intermediate
nuisance parameter $\kappah$. 
% We can do the marginalisation over $\kappah$
% by drawing samples from the two-dimensional grid and keeping only the
% $\kappa$ values, to form our final result, $\Pr(\kappa|\mathcal{D})$.

However, given an uncertain stellar mass to halo mass conversion, the PDF
$\pr(\kappah|\{\Mstar,z\})$ can become skewed relative to
$\pr(\kappah|\{\Mhalo,z\})$; this is because of the asymmetry in the
conversion from stellar mass through halo mass into $\kappah$. A long tail of
high halo masses gives rise to a tendency to overestimate $\kappah$.
If this shift is ignored, the resulting $\Pr(\kappax|\data)$ will be 
biased towards high values of $\kappax$. 

We find that we can correct this bias to some extent by artificially 
suppressing the tails of $\pr(\kappah|\{\Mstar,z\})$. Let the median of
this PDF be denoted $\kappah^{\rm med}$. We again take a large number of
calibration sightlines from the \MS catalogues, but this time generate a mock
stellar mass catalogue for each one. We then reconstruct each lightcone in the
same way as we would an observed field,
estimate $\pr(\kappah|\{\Mstar,z\})$, and extract its median. Accumulating
these samples and their corresponding true values of $\kappax$, we can form the 
conditional distribution $\pr(\kappax|\kappah^{\rm med})$. 
Then, when inferring $\kappax$ from an observed photometric catalogue, we would
estimate $\pr(\kappah|\{\Mstar,z\}_{\rm obs})$ 
using the halo model, compute the median value 
$\kappa_{\rm h,obs}^{\rm med}$, and then use the following alternative
version of 
\Eref{eq:kappaconv} to infer $\kappax$: 
\bea
\Pr(\kappax|\mathcal{D}) &=& \int \dee\kappah^{\rm med} 
   \Pr(\kappax|\kappah^{\rm med}) \Pr(\kappah^{\rm med}|\mathcal{D}) \notag \\
                        &=& \Pr(\kappax|\kappa_{\rm h,obs}^{\rm med}).
\label{eq:calkappaconv}   
\eea
Here, we have replaced $\Pr(\kappah^{\rm med}|\mathcal{D})$ with a delta
function centred at the observed median value $\kappa_{\rm h,obs}$. 
The procedure of reducing the full PDF for $\kappah$ to just its median is
risky: the simulated lightcones that have median $\kappah$ values to match are
not guaranteed to provide an accurate estimate of $\kappax$ via this PDF
look-up. We proceed with caution, quantifying the biases and PDF widths in the
sections below.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Results: Perfect Halo Data}
\label{sec:knownMh+z} 

We now put the reconstruction \proceedure outlined above into practice, first
inferring $\kappax$ from $\kappah$ in the case of hypothetical galaxy catalogues
with noiseless redshifts and halo masses. The reason for doing this is to
check the validity of the calibration process, and then also to  investigate
the primary sources of the convergence. It will also provide us with a measure
of the intrinsic uncertainty introduced by our assumption of all halos being
spherically-symmetric truncated NFW halos with Neto et al concentration--mass
relation.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How is $\kappah$ related to $\kappax$?}

\Fref{fig:jointkh-k} shows the joint distribution of $\kappah$ and $\kappax$
values for 100,000 randomly selected \MS lines of sight, assuming noise-free
halo masses and redshifts. In this case, the PDF $\pr(\kappah|\data)$ is a
delta function: to read off $\pr(\kappax|\data)$ we must take a thin horizontal
slice across this joint distribution. Note that the joint PDF plotted in this
figure is the product of  the conditional distribution that we need for
calibration, and also the prior PDF for $\kappah$ that we need to ensure that
the global distribution of $\kappah$ values is defaulted to in the case of
poor observational data. At fixed $\kappah$ we find in \Fref{fig:jointkh-k}
that the scatter in $\kappax$ grows with $\kappah$; our reconstruction is
better at reproducing under-dense lines of sight than over-dense lines of sight.
The effect of ignoring voids and the smooth mass component is evident in this
plot: $\kappah$ is significantly higher than $\kappax$, at any given $\kappax$
value. Multiplying by $\pr(\kappah|\data)$ and integrating over $\kappah$
gives a PDF for $\kappax$ centred at the correct place, by construction.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/cornerplot.eps}
\caption[Biased?]{The joint distribution of 
$\kappah$ and $\kappax$, from 100,000 reconstructed lines of
sight. $\kappah$ traces $\kappax$, but with a positive offset which arises from
$\kappah$ not accounting for any voids, dark structures or smooth mass
component. At fixed $\kappah$ the scatter in $\kappax$ grows with $\kappah$.}
\label{fig:jointkh-k}
\end{figure}


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How accurate is the $\kappah - \kappax$ calibration?}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/globaldist.eps}
\caption[magcut]{Recovering the global $\pr(\kappax)$, shown in red, 
from $10^{5}$ ray-traced lines of
sight. The black curve shows a histogram of 
sample reconstructed 
$\kappax$ values, each one drawn from an inferred PDF 
$P(\kappax|\{\Mhalo,z\}$)
in one of $10^{5}$ reconstructed lines of sight. 
The reconstructions were performed given
perfect knowledge of halo mass and redshift -- in this case
the reconstruction recovers the correct convergence.}
\label{fig:globaldist}
\end{figure}

\begin{figure*}
\includegraphics[width=\textwidth]{figs/where_is_the_kappa.eps}
\caption[magcut]{Which objects dominate the external convergence for a line of
sight? From left to right, the three figures show the cumulative contribution
to the total  convergence from individual halos ($\kappah$) as a function of
1)  distance from the line of sight, 2) magnitude and 3) redshift.   In each
panel, the solid line is the median cumulative contribution over a large
sample of sightlines, while dashed and dot-dashed show the ranges enclosing 68
and 95 percent of the sightlines repectively.}
\label{fig:where}
\end{figure*}

In this section, let us define the ``bias'' of the reconstruction of a given
line of sight as the difference between the expectation value of $\kappax$ over
the inferred PDF $\pr(\kappax|\data)$ and the known true value $\kappax^{\mathrm{true}}$.
Let us also define the ``width,'' $\sigma_{\kappa}$, to be half the width of
the interval containing the central $68\%$ of the posterior probability
$\pr(\kappax|\data)$. 

In an ensemble of $10^{5}$ reconstructed lines of sight, we find the the mean
bias to be $-9.5\times 10^{-6}$, and the mean width to be 0.01. This is
approximately 1.8 times smaller than the width of the global $\pr(\kappax)$. 
We find that our inferred $\kappax$ PDFs are consistent with the global
$\kappax$ distribution; Figure \ref{fig:globaldist} shows that sampling from
$\pr(\kappax|\data)$ in $10^{5}$ reconstructed lines of sight produces a
distribution of $\kappax$ values over the sky identical to the global
$\pr(\kappax)$. Given perfect knowledge of halo mass and redshift, the
calibration \proceedure provides an unbiased estimate of $\kappax$ that is
$\sim$2 times as precise as using the global $\pr(\kappax)$.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Which halos dominate the $\kappah$ distribution?}

Before investigating the uncertainties caused by imperfect knowledge of halo
mass and redshift, we investigate the uncertainties induced by a limits on the
magnitude of the observed galaxy sample, and on the field of view. The halos
in our catalogue are populated by galaxies and given magnitudes according to
the semi-analytic model of \citet{DeLucia+Blaizot2007}: by applying magnitude
cuts to our catalogue, we can investigate the amount of scatter caused by
unobserved halos. 

\Fref{fig:where} shows the cumulative contribution to $\kappah$ as a function
of projected distance from the line of sight, magnitude and redshift. We find
that most of the convergence comes from halos whose galaxies are close to the
line of sight.  Over half of the  convergence typically comes from halos
within 30 arcseconds of the line of sight; by 2 arcminutes, this fraction is
85\%. The contribution from halos beyond 2 arcminutes is relatively constant
at a contribution of 0.008$\pm$0.003. We find that ignoring halos beyond 2
arcminutes has no effect on the precision of the reconstruction; this is shown
in \Fref{fig:radcut}. As a function of magnitude, we find that $\kappah$
is dominated by objects with magnitudes between $i=18$ and $i=24$. Objects
brighter than $i=18$ are either too rare, or too close to the observer, to
make a significant contribution to the convergence. Objects fainter than
$i=24$ are too small to be important, unless they are extremely close to the
line of sight, but we find that including halos fainter than $i=24$ does not
improve the reconstruction.  \Fref{fig:magcut} shows the scatter on
$\kappah-\kappax$ (where $\kappah$ is shifted so that its mean is zero) as a
function of reconstruction magnitude limit. We do
not expect a deeper survey to decrease the size of the uncertainty in mapping
$\kappah$ onto $\kappax$. Halos at all redshifts out to the source redshift
(1.4, here) contribute to the convergence, but the largest contribution comes from
halos with $z \sim z_{\rm source}/2$.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/radius_scatter.eps}
\caption[magcut]{The 16, 50 and 84th percentiles of $\kappah$ minus
$\kappax$ as a function of the limiting radius of the halo
reconstruction. $\kappah$ has been shifted such that
$\left\langle\kappah\right\rangle=0$. The majority of the constraining power
comes from reconstructing halos with magnitudes between $18<i<24$.}
\label{fig:radcut}
\end{figure}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/mag_scatter.eps}
\caption[magcut]{The 16, 50 and 84th percentiles of $\kappah$ minus
$\kappax$ as a function of the limiting $i$ band depth of the halo
reconstruction. $\kappah$ has been shifted such that
$\left\langle\kappah\right\rangle=0$. The majority of the constraining power
comes from reconstructing halos with magnitudes between $18<i<24$.}
\label{fig:magcut}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Testing the Halo Model Reconstruction on Mock Galaxy Catalogues}
\label{sec:obsMstar+z}

We now move on to consider the halo model reconstruction of line of sight mass
distributions given noisy astronomical observables. A typical imaging survey
can be expected to provide measurements of the positions and magnitudes of
galaxies in a field;  spectra for some of the objects may either come from a
synergistic survey, or from targeted follow-up. In this section we quantify
the errors induced by inferring the halo mass and redshift from these
observables. 

As described in \Sref{sec:model:halos}, in this work we infer halo masses
given measurements of stellar mass. We will investigate two main sources of
error: inferring halo mass given observed stellar mass, and placing halos at
the wrong redshift due to photometric redshift error. Much work has already
focused on using photometric colours to infer stellar mass
\citep[\eg][]{AugerEtal2009} and redshifts \citep[\eg][]{BPZ}: we will
estimate the likely uncertainties on stellar mass and redshift based on this
work.  

\subsection{Making Mock Observational Catalogues}

While the \MS catalogues do already contain stellar masses for each galaxy, we
find that these are not well behaved at the low mass end due to unreasonably high dark matter stripping from satellite halos. We also wanted to be able to perform the functional test of
trying to recover the convergence having assumed the correct stellar
mass--halo mass relation. For these reasons, we assign a new stellar mass to
each halo in the \MS catalogues, according to the stellar mass--halo mass
relation of \citet{BehrooziEtal2010}. From this true  stellar mass we
simulate an observed stellar mass by drawing a sample from 
$\pr(\log{M^{*}_{\rm obs}}|\log{M^{*}_{\rm true}})$ which we take to be a
Gaussian of width $\sigma_{M_*}$ centred on $\log(M*_{\mathrm {true}})$. Where
a spectroscopic redshift exists stellar masses can be estimated with typical
uncertainties of 0.15 dex \citep{AugerEtal2009}; however with photometric
redshifts stellar mass uncertainties are typically three times as large. We
use $\sigma_{M_*}=0.15$ dex for halos with a spectroscopic redshift and
$\sigma_{M_*}=0.45$ dex otherwise. For photometric redshift errors we draw a
redshift from $\pr(z_{\rm true}|z_{\rm obs})$ which we take to be a Gaussian
of width $0.1(1+z_{\rm spec})$ centred on $z_{\rm spec}$, where $z_{\rm spec}$
is the halo's true redshift in the \MS catalogue.


\subsection{Reconstructing $\kappax$ given a spectroscopic redshift for every object}

Given an uncertain stellar mass and redshift it is possible to infer a
halo mass using the stellar mass--halo mass relation of
\citet{BehrooziEtal2010}. This \proceedure requires an inversion of the
relation given in \citet{BehrooziEtal2010} and correctly inverting the
relation's uncertainties requires care: the \proceedure we use to do this
is given in \Aref{appendix:MSMH}. By drawing sample halo masses
and redshifts, we can infer a sample $\kappah$ using the \proceedure of
\Sref{sec:model}; repeatedly drawing samples allows us to
estimate $\pr(\kappah|\data)$ for each reconstructed line of sight. We then
transform this into our target PDF $\pr(\kappax|\data)$.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Width.eps}
\caption{The widths of the \infered PDFs $\pr(\kappah|\data)$ for
$10^5$ lines of sight, given different quality of data. Blue:
spectroscopic redshift for every halo with $i<26$; Purple: 
spectroscopic redshift for every halo with $i<23$, and every halo with $i<24$
within 1 arcminute; Cyan: spectroscopic redshift for every halo with $i<22$; 
Green: all the objects in the field have only photometric redshifts.}
\label{fig:reconwidths}
\end{figure}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Widthvshilberrt.eps}
\caption{Width of the \infered PDF $\pr(\kappax|\data)$ versus the true
$\kappax$ along a line of sight. Blue assumes a spectroscopic redshift for
every halo, whilst green assumes only photometric redshifts. The width of the
\infered $\pr(\kappah|\data)$ increases with $\kappax$.}

\label{fig:widthsvsH}
\end{figure}

The best possible reconstructions of $\kappax$ will come from having a
spectroscopic redshift for every single object in each field
(\Fref{fig:reconwidths}).  In terms of telescope time, such a reconstruction
would be prohibitively expensive, but we investigate this scenario as an ideal
case. Reconstructing the lines of sight with perfect knowledge of the redshift
but an uncertain stellar mass, we find that the width of $\pr(\kappax|\data)$
grows with the expectation value of $\kappax$ (\Fref{fig:widthsvsH}). The low
$\kappax$ lines of sight are relatively empty, and so there are few
opportunities for uncertainties in the halo masses to \propogate into $\kappax$
uncertainties. The median reconstruction width in this idealised situations is
0.01; some 22\% of lines of sight would have a reconstruction width less
than 0.01. 

% PJM: Note that I removed talk of void correction here - surely we should be
% just applying the method we describe and inferring $\kappa$?
%
% TEC: yes.

\subsection{Reconstructing $\kappax$ from photometry alone}

Inferring the stellar mass of a galaxy from its magnitude and colours requires
an estimate of how far away the galaxy is; without a spectroscopic redshift
the \infered stellar mass is less precise. However, obtaining photometry has
much lower observational cost; over the next few years several large area
photometric surveys will reach 24th magnitude \citep{Euclid,LSST}, these will
provide sufficient data to reconstruct lines of sight {\it without} additional
observations. In principle the photometric redshift is correlated with the
\infered stellar mass, however we do not model this effect since the
convergence from the outskirts of an individual halo is only weakly \dependant
on redshift at fixed mass: the redshift error has only a small effect on the
inferred $\pr(\kappax|\data)$ when compared to the effect of uncertain stellar
masses.  With only photometric redshifts the uncertainty on
$\kappah$ is larger than in the spectroscopic case and this
\propogates into a broader $\pr(\kappax|\data)$, although the photometric
reconstruction still typically produces a 50\% improvement compared to the
precision of the global $\pr(\kappax)$ (\Fref{fig:widthsvsH}).


\subsection{Reconstructing $\kappax$ with partial spectroscopic coverage}

While a fully photometric reconstruction provides useful constraints on
$\pr(\kappax|\data)$, targeted spectroscopy can provide additional constraints
on the masses and redshifts of halos whose $\kappah$ contribution have the
largest absolute uncertainty. Obtaining spectra of bright ($i<22$) objects is
relatively fast with large telescopes: however, we find that if spectroscopic
redshifts were known for all $i<22$ galaxies in our field the reconstruction
improves slightly upon the purely photometric reconstruction, although the
improvement can depend strongly on the details of the particular line of
sight. Obtaining spectra for fainter objects would be correspondingly more
expensive, but if spectroscopic redshifts could be obtained for all $i<23$
galaxies and all $i<24$ galaxies within 1 arcminute of the line of sight, the
$\pr(\kappax|\data)$ would be almost as good as having complete spectroscopic
coverage (\Fref{fig:reconwidths}). High $\kappax$ lines of sight benefit the
most from additional spectral coverage, since these LoS have the most
uncertain $\kappah$. Consistent with our previous findings the lowest $\kappax$
lines of sight have the most constrained $\kappax$ PDFs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Systematic Errors due to Sample Selection}
\label{sec:bias}

\begin{figure*}
\includegraphics[width=\textwidth]{figs/biasplots.eps}
\caption{Convergence accuracy from combining subsets of
lenses. By subtracting the true (ray-traced) convergence from the
\infered $\pr(\kappax)$ for each line of sight we are left with a PDF that
should be estimating zero; these can be multiplied together for multiple
lines of sight to emulate a joint likelihood analysis, and 
test for possible bias in it. These plots show the
expectation value of $\prod_{i=1}^N \pr_i(\kappax-\kappax^{\rm true})$ --
deviations from zero constitute biases. The solid, dashed and dotted
lines correspond to combinations of 
20, 5 and 2 sightlines respectively. Green lines show the results
from multiplying $\pr(\kappax|\data)$ \infered from photometry alone, whilst red
lines are from multiplying $\pr(\kappax)$ \infered from photometry and a
spectroscopic redshift for all halos with $i<23$ and all halos within 1
arcminute and $i<24$. The leftmost plot shows randomly selected lines
of sight. The central plot shows sight lines randomly selected from the
33\% of lines whose P($\kappax$) is most tightly constrained. The right
hand plot shows only lines of sight with external shear of 0.03 or
greater.}
\label{fig:biasplots}
\end{figure*}

While it is good to reconstruct $\kappax$ precisely, it is more important that
$\kappax$ is reconstructed accurately. The reconstruction must not be biased. 
We test the accuracy of our reconstructed $\pr(\kappax|\data)$ in the following
way: for each line of sight we have an estimator for the true convergence along
that line of sight, by subtracting the line of sight's ray-traced convergence
$\kappax^{\rm true}$ from $\pr(\kappax|\data)$ we have an estimator of zero, $\pr(\kappax-\kappax^{\rm true}|\data)$.
 Since the $\pr(\kappax-\kappax^{\rm true}|\data)$ for
each line of sight is an \independant estimator of zero, the PDFs from $N$ lines of sight
can be combined according to
\be
\label{eq:bias}
\mathcal{P}_N = \prod_{i=1}^N \pr_i(\kappax-\kappax^{\rm true})
\ee
In this section, we quantify the bias as the size of the deviation in the
expectation value of $\mathcal{P}_N$ from zero. If the bias of $\mathcal{P}_N$
is smaller than the half-width of $\mathcal{P}_N$, our $\kappax$ estimators can
be considered accurate. Since the width of $\mathcal{P}_N$ decreases as more
lenses are combined a small bias will eventually be found for all estimators
In the context of measuring time delay distance at the one percent level the
expectation value of $|\mathcal{P}_N|$ needs to be less than 0.01.


The source of systematic error that we investigate is that of sample
selection: we define three different selections of lines of sight, and compute
the bias present in each one in turn, as a function of data quality. The
results described below are illustrated in \Fref{fig:biasplots}.


\subsubsection{Selecting random lines of sight}
\label{sec:bias:random}

We first consider a purely random selection of lines of sight. With the purely
photometric reconstruction, there is no evidence of bias, even after combining 20
lines of sight. If these lines of sight hosted time
delay lenses, the bias number would correspond to a systematic error of
0.5\% in time delay distance. Since the statistical distance uncertainties due
to lens modelling and time delay estimation are likely to be at the 3-4\%
level \citep{SuyuEtal2010},  only a sample containing 200 or more lenses would
be limited by the residual bias  following external convergence
reconstruction.


\subsubsection{Selecting only the lines of sight with tight $\pr(\kappax|\data)$}
\label{sec:bias:tightPDF}

Since follow-up campaigns (such as high resolution imaging, or time
variability monitoring) are expensive, it is likely that only a subset of
detected objects will be observed further. By pre-selecting objects that have 
the most well constrained convergence, the cosmological value per lens can be
increased. However, this selection has the potential to induce a bias. It is
probable that only photometry will be available at the time of sub-sample
selection (although spectroscopic follow-up might be conducted at a later
date). We mimic such a selection by drawing lines of sight only from those in
the lowest third of $\sigma_{\kappa}$, given a purely photometric
reconstruction of their fields. 

We find that selecting the most tightly constrained lines of sight has no impact on the
bias -- our reconstruction is most \succesful for the lowest
$\kappax$ lines of sight. With targeted spectroscopic follow-up of the selected lines of sight
there is negligible improvement compared to photometry alone, since the best constrained lines of sight are
the most empty, and it is the high-$\kappax$ lines of sight that benefit the
most from spectroscopy. Photometry of the field is sufficient to adequately
select the best lines of sight for cosmology -- and doing so greatly increases
 the precision of the cosmological constraints per system, with no degradation of the accuracy.
Since lenses are typically found in locally over-dense environments, it is unlikely that 
an almost empty line of sight would contain a lens; it is somewhat optimistic to 
suggest that nearly empty lines of sight could be used for time-delay cosmology. 


\subsubsection{Selecting only high shear lines of sight}
\label{sec:bias:tightPDF}

Time delay lenses are often selected for follow-up based on their images'
brightness (to make monitoring observations less expensive), their images'
separation (to decrease the covariance between the ground-based image
light-curves), or the fact that they are quadruply-imaging rather than
doubly-imaging, since this yields 3 time delays instead of 1, a higher
magnification and a more informative Einstein Ring system. All three of these
properties favour lenses with high convergence and shear along their lines of
sight. Focusing on the quad selection, we might expect many of these systems
to have significant external shear (since the cross-section for 4 image
production is so sensitive to ellipticity in the lens mass distribution (or
equivalently, external shear due to the lens' environment). 

By selecting only lines of sight with an external shear of $\gammax>0.03$ we
can test the impact of shear selection. We find that in this sample, $\kappax$
is systematically underestimated at the $\sim$0.003 level (corresponding to a
0.3\% systematic error in distance; in the absence of other sources of uncertainty, this
systematic error would be significant in a sample of 40 lenses). 
This effect is mitigated if only
the lines of sight with both $\gammax>0.03$ and well constrained $\pr(\kappax|\data)$ are
used, but biases at the $\sim$0.001 level remain. Since our model does not
include shear constraints it is not surprising that a selection function based on shear
can induce a bias. A more sophisticated model that includes the shear
recovered from the lens modelling may be less susceptible to this bias. The
toy selection model used here ($\gammax>0.03$) is likely to be a much
stronger selection than reality, but nevertheless it is worth noting that the
reconstruction \proceedure will be biased if lens selection functions are
extreme and unaccounted for.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\section{Improving precision by including additional information}
%\notes{placeholder for shear}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discuss}

We have shown that reconstructing the matter due to halos along any line of
sight can improve the constraints on the external convergence along that line
of sight, with, depending on sample selection,  the width of
$\pr(\kappax|\data)$ being up to a factor of two smaller than the global
$\pr(\kappax)$, and  we have quantified the residual bias in the $\kappax$
estimates under our calibration assumptions. We now revisit these assumptions.

The total convergence along a line of sight is strongly correlated with the
reconstructed $\kappah$. However, since our model ignores voids and assumes
all halos follow a spherical truncated-NFW profile our halo model does not
include all of the relevant physics; hence, the width of our resulting
$\pr(\kappax|\data)$ is still typically $\sim$0.01 for any given lightcone,
even with a perfect knowledge of every halo's virial mass and redshift. To
make further progress a more advanced treatment of both voids and halos will
be necessary. \citet{KarpenkaEtal2012} find that their supernova data prefer,
in the context of their simple halo model, a truncated isothermal profile for
the galaxy mass distributions. Weak galaxy-galaxy and cluster-galaxy  lensing
studies \citep[\eg][]{GavazziEtal2006,JohnstonEtal2007} also suggest an
approximately isothermal profile for the mass-shear correlation function;
however, at large radii these profiles are dominated by the effects of
neighbouring halos, which should be taken into account by our model. Further
iterations on the analysis presented here should include the stellar mass
distributions that cause the isothermal density profiles in the centres of
galaxies, although we do not expect this to have a big impact on the model.
Likewise,  halo ellipticity may have some small effect on the predicted
convergence. 

Filaments and voids are more difficult to model, but simple forms could in
principle be derived from the structures found in the simulations, and
included in the halo model in some way. Most importantly for the highest
$\kappax$ lines of sight will be a better group and cluster model:
\citet{MomchevaEtal2006} and  \citet{WongEtal2011} recommend using models
where dark mass is assigned to both galaxy-scale halos and halos for the
groups and clusters they occupy: to make this work, one could incorporate  a
group and cluster finder, and then infer halo mass from optical richness
\citep[\eg][]{MaxBCG} in tandem with BCG stellar mass.

Interestingly, we have found that it is the most empty lines of sight that 
can be reconstructed with the highest precision. $\kappax$ estimates for empty
lines of sight receive few contributions from halos, and a large contribution
from voids; since they have the tightest PDFs after the reconstruction it
seems that our model's biggest uncertainties are driven by naively
reconstructing halos rather than neglecting voids. With a photometric
reconstruction of the field there is a significant broadening, but the
resulting precision is still typically 50\%  higher than using the global
$\kappax$ distribution. 

Since the uncertainty on $\pr(\kappax|\data)$ is $\sim$0.01 even
with perfect knowledge of halo mass and redshift, it seems that modelling uncertainties
from voids, deviations from sphericity and dark matter clumping within the
main halo dominate the total $\kappax$ uncertainty even with very
uncertain stellar masses. Inferring halo ellipticity and dark matter
clumping will likely always remain a difficulty for line of sight
reconstruction; but as \Fref{fig:magcut} shows, observing deeper
than 24th magnitude does not significantly help the reconstruction.


For a small fraction of lines of sight, $\pr(\kappax|\data)$ remains very
broad even after applying our reconstruction; these lines of sight are
typically the most over-dense lines of sight in the universe. For
time-delay cosmography the most observationally expensive tasks are the
light-curve monitoring and high resolution follow-up imaging and spectroscopy,
while making photometric observations of a
4$\times$4 arcminute patch of sky survey down to 24th magnitude is
relatively cheap. We have shown that with a single epoch observation of
the region around a strong lens it is possible to infer $\pr(\kappax|\data)$.
If a line of sight has a broad $\pr(\kappax|\data)$ it can be rejected {\it
before} the investment of follow-up. We find that
selecting only the lines of sight with the most tightly constrained
$\pr(\kappax)$ does not induce a bias in $\kappax$, and hence distance.
For the most over-dense lines of sight,
the precision of $\pr(\kappax|\data)$ is improved noticeably by the addition
of spectroscopic information; currently insufficient time-delay systems are
know to choose a subset based on their reconstructed $\pr(\kappax|\data)$.
Spectroscopic coverage will definitely be useful for extracting cosmology from
over-dense lines of sight.

The method we have outlined can also be used to estimate the external shear
along a line of sight. Shear is an observable that can be extracted from
strong lens modelling, however there is a degeneracy between internal and
external shear. When the Einstein Ring data are very good it is possible to
disentangle external and internal shear \citep[\eg][]{xxx}, but there are
still significant uncertainties: \citet{WongEtal2011} attempted to match the
shear from strong lens models with a reconstruction of the local lens group
environment, but found a tension between the strong lens model and the
reconstruction of the environment. Given the \citet{WongEtal2011} results
it is unclear whether the external shear from lens models can be
reconciled with a line of sight reconstruction. Alternatively, it may be possible 
to infer external shear using weak lensing information from near the line of sight. 
If the true external shear can be
measured, it provides an additional constraint on which of the \MS lines of
sight are similar to the reconstructed line of sight. \citet{SuyuEtal2012}
found that for RXJ1131 combining shear constraints with galaxy number count
over-density, gave a significantly different $\pr(\kappax|\gamma,N_{45})$
compared to the PDF from number count over-density alone,
$\pr(\kappax|N_{45})$.

Extending our model to include shear we find that given
perfect knowledge of the halo mass and redshift the ray-traced external shear
$\gamma$ and the reconstructed external shear $\gamma_{\mathrm{h}}$  are
similar, with 68 percent of lines obeying
\be
\label{eq:shearineq}
|{\boldmath{\gammax}-\boldmath{\gamma_{\mathrm{h}}}}| < \mathrm{0.025}
\ee 
Future work should investigate whether $\gamma_{\mathrm{h}}$ can be used
to improve the accuracy and precision of $\kappax$ estimation, given a
reconstruction of the line of sight. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
\includegraphics[width=\columnwidth]{figs/biasplots3.eps}
\caption{Convergence estimation accuracy using the full  $\pr(\kappax|\kappah)$
distribution, rather than its median.  As in \Fref{fig:biasplots}, solid,
dashed and dotted lines show combinations of 20, 5 and 2 lines of sight
respectively, while green lines show the inferences 
from photometry alone, red lines from photometry and targeted spectroscopy 
(assuming a spectroscopic redshift for all
halos with $i<23$ and all halos within 1 arcminute and $i<24$), and blue lines
from the unrealistic assumption of a spectroscopic redshift for all galaxies
in the field. }
\label{fig:no-median-tricks}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The reduction of $\pr(\kappah|\data)$ to just its median value, before using
it to look up the appropriate $\pr(\kappax)$ from the simulated sightline
ensemble, is reminiscent of the procedure followed by \citet{SuyuEtal2010},
and Greene et al (in prep.) The reconstruction method can be seen as the
limiting case of the weightings explored by Greene et al: rather than using
weighted number counts in an aperture, we treat each galaxy individually, and
predict  $\kappa_{\rm h,obs}^{\rm med}$ for use in their place. One
significant disadvantage of these types of method is that they impose a
bottleneck in the flow of information. Once you have compressed to one number,
it is difficult to incorporate more information later; you have to recompute
all the calibrations. Using the full PDF for $\kappah$ is the more correct
thing to do: at present, however, it suffers from significant bias in the
photometric data case. \Fref{fig:no-median-tricks} shows how $\kappax$ is
overestimated, as a result of the high scatter in halo mass for objects with 
high stellar mass. As has already been noted, 
future work should focus on increasing the precision of the halo
mass estimates. 

In this work, we have used 
the \MS as a calibration tool. If the real Universe is not
like the \MS, then this calibration will be incorrect. Repeating this 
study using
a different simulation to make the test catalogues would allow us to quantify
the sensitivity of our results to the simulation used. Similarly the use of a
different semi-analytic model to paint galaxies onto halos, and an alternative
stellar mass--halo mass relation would both enable similar exploration of
these systematic errors. \citet{SuyuEtal2010} used the relative over-density to mitigate this
effect, but it does not totally remove the dependence on simulation.
It is also possible that baryonic physics may alter   
the radial profile of dark matter halos, even on large scales. \citet{Semboloni+2012}
found that baryonic physics had a 30-40\% impact on three-point shear statistics, it is
unclear how baryons affect one-point convergence statistics compared to the pure dark matter
simulations used in this work.


In particular, the method presented here is tied to the simulations at two
points: the prior PDF for $\kappah$, and the conditional distribution
$\pr(\kappax|\kappah)$ used to convert halo model convergence to total
convergence. The first tie could potentially be avoided if the halo mass
estimation gave rise to a reasonable $\pr(\kappah|\data)$ on its own.
Possibilities for improving the precision of the halo mass estimation are
discussed above. The second tie is more difficult, since breaking it means
modelling the unseen mass structures and voids. It
should be possible to infer hierarchically  the parameters of a flexible model
for these things from the data itself, as demonstrated by
\citet{KarpenkaEtal2012} (albeit under the assumption of scatter-free scaling
relations) -- how this affects the cosmographic precision is to be
investigated. When working with wide field imaging surveys,  weak lensing shears will be
available around every line of sight:  fitting these with the halo models
described here in order to constrain the hyper-parameters of the model presents a 
possible test of our halo model prescription against real observations.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
\label{sec:conclude}

In this work we have investigated a simple halo model prescription for
reconstructing all the mass along a line of sight to an intermediate redshift
source. We have used the ray-traced lensing convergence along lines of sight
through the Millennium Simulation to test this approach, and to calibrate
estimates of the total convergence made by summing the convergences due to
each object in a photometric catalogue. Having found that the reconstruction
process is accurate and precise given perfect knowledge of halo mass and redshift, we
investigated the effects of reasonable uncertainties in the stellar mass and
redshift of each halo, and propagated these uncertainties into a
$\pr(\kappax|\data)$ for each line of sight. We also defined three different
possible line of sight selections, and investigated the bias induced by these
selections. We draw the following conclusions:

\begin{itemize} 

\item Despite our model's simplicity, its reconstructed $\kappah$ values are
good tracers of $\kappax$. $\kappah$ is biased due to our ignorance of voids, but we found that this can be calibrated out. We found that with perfect knowledge of
the halo mass and redshift (from the Millennium Simulation catalogues), for a
typical line of sight the calibrated reconstruction gives an unbiased estimate
of $\kappax$ that is a factor of 2 more precise than the global $\pr(\kappax)$.

\item With uncertain halo masses and redshifts, we find that
$\pr(\kappah|\data)$ is still a useful indicator for inferring
$\pr(\kappax|\data)$ from the ensemble of simulated lines of sight, but the
resulting PDFs tend to be much broader than for perfect halo mass and redshift
reconstructions.

\item It is very rare for halos further than 2 arcminutes from the line of
sight to make a significant contribution to $\pr(\kappax|\data)$. Including
halos whose host galaxy is less luminous than $i=24$ does not significantly
improve our reconstruction precision.  A photometric survey to this depth of a
4$\times$4 arcminute patch around the target would approach the limiting
uncertainties of our simple reconstruction recipe, and yield a 
$\pr(\kappax|\data)$ that has, on average, a width of 0.016. This is 1.5 times
less broad than the global $\pr(\kappax)$.

\item  For the most over-dense lines of sight, the reconstruction produces a
broad PDF; conversely, we find that the lines of sight with the sharpest
inferred $\pr(\kappax|\data)$ are typically under-dense. Since the
reconstructions described here can be performed before follow-up time is
invested, it will be possible to select targets by the precision of their
$\kappax$ estimates. This will be useful
in an era when there are more known lenses than can be followed-up.

\item Photometric data is sufficient  to select the best lines of sight for
follow-up. Spectroscopic coverage helps to tighten  $\pr(\kappax|\data)$ for
high $\kappax$ lines of sight, but is of less use for low $\kappax$ lines of
sight.

\item Selecting from the highest precision 33\% of the reconstructed lines of sight
results in a sample with low bias, 0.1\% in terms of the time delay distance,
and a statistical uncertainty due to line of sight mass structure that is half
that of the parent sample. Neglecting other sources of error, the residual systematic error would be equal to the
overall statistical uncertainty in a sample of around 200 lenses.

\item Conversely, selecting lines of sight with high shear ($|\gamma| >
0.03$ (as might be done inadvertently by focusing on four-image or wide
separation lenses) results in a sample with bias of 0.3\% in time delay
distance. Such a systematic error would become significant in a sample of $\sim$30 lenses. 

% \item With only a photometric reconstruction of all time delay lens fields,
% and following up only the systems with the most precise $\kappax$ estimates,
% the width of the dominant statistical uncertainty in time-delay cosmography
% can be halved, without inducing biases at the one percent level.

\end{itemize}

% PJM: Im not sure this is the right note to end on. 

% TEC: I liked it! but it's open to discussion.


% External convergence is not the only uncertainty in time delay cosmology, but
% for systems like B1608$+$656 it is the dominant one. For most lines of sight
% lens modelling induces uncertainties at the $\sim$3 percent
% level, which far exceeds the typical $\kappax$ uncertainties after applying our
% reconstruction \proceedure. By using reconstruction methods such as that
% explored here to select the most appropriate 
% lenses for follow-up, the uncertainties due to line of sight
% convergence will become a sub-dominant source of error.

While we have tested our reconstruction method against realistic simulations
of line of sight mass distributions in the Universe, our method is also 
calibrated to these simulations. Testing this assumption in the short term,
and replacing it with an empirical calibration (or hierarchical inference) in
the longer term, are worthy goals for future work. The halo model framework is
flexible enough to enable many such improvements, including, quite naturally,
the incorporation of more information from observations. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgements}
 
We thank Risa Wechsler and Peter Behroozi 
for useful discussions and suggestions.
\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Inferring $\Mhalo$ given a noisy measurement of $\Mstarobs$}
\label{appendix:MSMH}

To estimate the convergence caused by a halo we need to know its mass; how can 
halo mass be \infered from a noisy estimate of the stellar mass $\Mstarobs$
of a galaxy at redshift $z$. We seek the posterior
PDF $\Pr(\Mhalo|\Mstarobs,z)$, which can be expanded as follows:

\begin{eqnarray}
&& \Pr(\Mhalo|\Mstarobs,z) = \notag\\
&& \int d\Mstar \Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|\Mstarobs,z), \notag\\
&\propto& \int d\Mstar \Pr(\Mstarobs|\Mstar) \Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z),
\label{eq:mhalo-mstar}
\end{eqnarray}
where we have used Bayes' Theorem twice to replace
$\Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|z)$ with 
$\Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z)$, and 
to invert $\Pr(\Mstar|\Mstarobs)$ into the sampling
distribution $\Pr(\Mstar|\Mstarobs)$, which we recognise as the likelihood
function for the observed stellar mass. Note that the ``true'' $\Mstar$ of the
galaxy is marginalised out: we are only interested in inferring the halo
mass. The last two terms in
\eqref{eq:mhalo-mstar} are the $\Mstar-\Mhalo$ relation from
\citet{BehrooziEtal2010}, and the halo mass function $\Pr(\Mhalo|z)$, at the
given redshift. We can
tabulate the product of these two from our Millennium Simulation catalogue,
constructing a two-dimensional histogram of halo masses and their associated
true stellar masses (drawn from the Behroozi relation). 

For each galaxy, we compute the likelihood function for its $\Mstarobs$ as a
function of the unknown $\Mstar$, and multiply it by our tabulated joint PDF.
This heavily down weights halos with $\Mstar$ values outside the observed
range. We then do the marginalisation integral by Monte Carlo, drawing
(two-dimensional) sample parameter vectors
from the down weighted histogram, discarding the $\Mstar$ values, and
constructing a one-dimensional histogram that is an estimate of
$\Pr(\Mhalo|\Mstarobs)$.

If the redshift of the galaxy is uncertain, we need to take this
uncertainty into account; for example, for each sample drawn from the
photometric redshift posterior PDF $\Pr(z|{\rm colors})$, we can draw a
sample $\Mhalo$ using the above procedure.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:

% bubble -f paper-lcr.tex references.bib 
% \input{paper-lcr.bbl}

% \bibliographystyle{apj}
% \bibliography{references}

\input{references.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{lastpage}
\bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
