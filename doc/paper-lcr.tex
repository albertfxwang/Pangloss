%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pangloss: Testing the reconstruction method
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

% \voffset=-0.8in

% Packages:
\input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}

% Macros:
\input{macros.tex}
\input{addresses.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Line of Sight Mass Reconstruction]
{Reconstructing the Lensing Mass in the Universe \\
from Photometric Catalog Data}
    
\author[Collett \etal]{%
  Thomas~E.~Collett$^{1}$\thanks{\collettemail},
  Philip~J.~Marshall$^{2}$,
  Matthew~W.~Auger$^{1}$,
  Stefan~Hilbert$^{3}$,
\newauthor{%
  Sherry~H.~Suyu$^{4}$,
  Zachary~Greene$^{4}$,
  Tommaso~Treu$^{4}$\thanks{\packard},
  Christopher~D.~Fassnacht$^{5}$,}
\newauthor{%
  L\`eon~V.~E.~Koopmans$^{6}$,
  Roger~D.~Blandford$^{3}$} 
  \medskip\\
  $^1$\ioa\\
  $^2$\oxford\\
  $^3$\kipac\\
  $^4$\ucsb\\
  $^5$\davis\\
  $^6$\kapteyn
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2012}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract} 

\todo{PJM}{Make abstract match conclusions.}

Strong gravitational lenses can provide high precision cosmological distance
measurements; one of the most important sources of systematic error in these
estimates is the additional mass along the line of sight to the source. Weak
lensing perturbations by galaxies and groups in this beam can contribute an ``external
convergence'' $\kappa$ that dominates the  uncertainty in the inferred
distances; likewise, it may also contaminate estimates of the luminosity of
objects at high redshift (such as reionisation-era proto-galaxies, and type Ia
supernovae standard candles).  We characterise this uncertainty by marginalising
over a probability density function for $\kappa$: here, we investigate the use
of a simple halo model to estimate $\Pr(\kappa)$ given noisy estimates of the
photometric redshift and stellar mass of galaxies observed in optical imaging
surveys of the field in question. We use mock catalogs from the Millenium
Simulation and compare our reconstructed $\Pr(\kappa)$ to ray-traced $\kappa$ values,
we find that our model produces a precise estimator of $\kappa$ with only small biases.
For each lightcone the individual $\Pr(\kappa)$ from this reconstruction process are
typically 1.8 times more precise than the global distribution of $\kappa$ given perfect knowledge 
of the halo mass and redshift. After incorporating uncertainties on redshift and halo and stellar masses
we typically find that the reconstruction yields an improvement factor of 1.4. For each line of sight the
 $\Pr(\kappa)$ can be formed before the investment of light-curve monitoring: by following up only the 
most constrained lines of sight a factor of 2 improvement over the global $\pr(\kappax)$ should be 
achievable.

\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing   --
  methods: statistical    --
  galaxies: halos         --
  gaaxies: mass function  --
  cosmology: observations
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:intro}

Every distant object we observe has had its apparent shape distorted,
and size and total brightness magnified (or demagnified) by a compound
weak gravitational lens constructed from all the mass distributed
between us and it. As \citet{Vale+White2003} and \citet{HilbertEtal2007}
showed, there are no empty lines of sight through our universe. This
fact makes gravitational lensing a potentially important source of
systematic error for any estimate of luminosity (or distance); this 
issue has been 
raised for \eg type Ia supernovae by
\citet[][]{Holz+Wald1998,Holz+Linder2005}, for gamma ray bursts by
\citet[][]{Oguri+Takahashi2006,Wang+Dai2011},  and for high redshift
galaxies by \citet{BradacEtal2009}, among others. 

Along lines of sight containing strong gravitational lenses, the
perturbative effects of line of sight mass structure have been found to
be particularly important, with foreground and background structures
having a significant effect on the inferred lensing cross-section
\citep[\eg][]{WongEtal2012} and distance ratios
\citep[][]{DalalEtal2005}. Indeed, \citet{SuyuEtal2010} found that in
time delay lens cosmography the so-called ``external convergence''
$\kappa$ due to mass structures along the (unusually over-dense) line
of sight to the quadruply-imaged radio source B1608$+$656 was the
dominant source of uncertainty in their 6\% measurement of Hubble's
constant. The problem is that one simply doesn't know how magnified and
distorted the source has been, because the unlensed source is
unobservable. The external shear can potentially be recovered in the
mass-modelling of the lens, but the convergence is undetectable from the
image positions, shapes and relative fluxes; this is the famous {\emph{ 
mass sheet-degeneracy}} \citep[see e.g.][for details]{FalcoEtal1985}.

How can we correct for this perturbative lensing and make accurate
measurements through the Universe? When inferring global quantities
(such as the cosmological parameters), combining the results from a
large number of independent objects will tend to reduce the uncertainty
due to external convergence, as the ensemble-averaged magnification
approaches zero for an unbiased sample \citep[\eg][]{Holz+Linder2005}.
If the sample is biased, however, some residual systematic error will
remain even as the statistical uncertainty decreases. Lensing bias will
be present (to varying degrees) in any sample {\it selected} by
brightness (which includes magnification), or any other quantity that
depends on $\kappa$. This bias may be introduced either at the object
detection stage, or later on when making decisions about which objects
to study further.  Moreover, we expect these biases to be strongest in
the strong lens systems, where magnification is highest. Large samples
of lenses are expected to be discovered in the next decade in
ground-based optical imaging surveys \citep{Oguri+Marshall2010}: both
the detectability of these lenses,  and the selection of sub-samples of
them for further observation, could be sensitive to the external
convergence. 

Several attempts have been made to do better than simply constructing a
large sample of objects, and averaging over the resulting convergence
distribution. The weak lensing effect can be detected observationally 
by measuring the
small distortions it induces on the images of many background galaxies
in the field \citep[see e.g.][for a review]{Schneider2006}. In a 30''
radius aperture around the strong lens Q0957$+$561,
\citet{NakajimaEtal2009} used deep HST imaging to measure a weak lensing
convergence of $0.17\pm0.06$, which was used in the time delay distance
measurement of \citep{FadelyEtal2009}. While this system has an
unusually high external convergence due to its location on the edge of a
cluster of galaxies, the precision with which the convergence at the
lens position can be estimated is indicative of what can be achieved
with high quality weak lensing shear data. We note that this uncertainty
is not dependent on the value of the convergence, but instead depends
primarily on the number density of weakly lensed, measurable galaxies
available. 

In order to make more precise estimates of the convergence at a given
sky position, we need more information.   There have been some attempts
to reconstruct the local and line of sight mass distribution in strong
lens fields in some detail, based on photometric and spectroscopic
surveys of the galaxies nearby. These efforts have focused on  detecting
galaxy groups, ascertaining the visible galaxies' membership of those
groups, and assigning mass to the group and galaxy halos in order to
predict the external shear apparently required by the strong lens
models. Surveys by
\citet{Fassnacht+Lubin2002,AugerEtal2007,WilliamsEtal2006,MomchevaEtal2006}
all found groups of galaxies both hosting, and lying  along the line of
sight to, known gravitational lenses. Initial estimates of the effect of
these structures suggested the importance of assigning mass to both
galaxy and group halos, and to allowing for significant uncertainty in
the centroids of group halos. 

The probability density function (PDF) for the external convergence
given our available data $\data$, $\Pr(\xkappa|\data)$,  is the  key
quantity we seek, since by marginalising over this distribution we can
correctly propagate the uncertainties due to line-of-sight perturbations
(as \citeauthor{FadelyEtal2009} did).  
%
\citet{GunnarssonEtal2006} investigated a related PDF,  for the
magnification, using a galaxy halo model. Applying empirical galaxy
scaling relations both to simulate mock catalogs and then to reconstruct
the line of sight mass distribution. While they did not explore highly
overdense lines of sight, or the impact of groups and clusters, they
found that under their simplifying assumptions, the dispersion in
apparent source brightness due to lensing magnification could be reduced
by a factor of two.
%
\citet{WongEtal2011} estimated the PDF for the external shear,
$\Pr(\gamma|\data)$ from their survey data, running similar Monte Carlo
reconstructions of the mass in nine lens fields based on
\citeauthor{WilliamsEtal2006} and \citeauthor{MomchevaEtal2006}'s
photometric and spectroscopic measurements of galaxies close to the line
of sight. They then  compared the resulting predicted shear
distributions with the external shear demanded by the strong lens model.
Their reconstructions showed most of the shear to have been generated by
bright galaxies within 2~arcminutes of the lens, and that both line of
sight structures and the group of galaxies in each lens plane contribute
significant proportions of the shear. They found significant
discrepancies between the lens model shear and the Monte Carlo
predictions, but were unable to distinguish between the environment
modelling and the strong lens modelling as the cause of these
discrepancies.

These observational investigations have provided some very useful
insight into the problem of convergence estimation.  Coming from a more
theoretical direction, large numerical simulations have been used to
predict, from first principles, the distribution of likely external
shears and convergences along various lines of sight, including those
containing strong lens systems.  \citet{Holder+Schechter2003} and
\citet{DalalEtal2005} carried out ray-tracing calculations in N-body
simulations to estimate the distribution of external shear values. 
\citet{HilbertEtal2009} performed similar ray-tracing experiments
through the Millenium Simulation \citep{SpringelEtal2005}, generating a
predicted $\kappa$ at every position in a simulated sky.
\citet{HilbertEtal2009} found that \MS lines of sight with strong lenses
were not biased towards high $\kappa$, although selection functions for
discovering or using particular samples of strong lenses were not taken
into account. Addressing the possibility of using weak lensing shear to
reconstruct the magnification~$\mu$ that affects cosmography with
standard candles (and standard sirens), \citet{HilbertEtal2011} used the
\MS ray-tracing results to explore optimal mapping techniques and
quantify their performance. They found that deep weak lensing shear
surveys (with background galaxy number densities of 100 arcmin$^{-2}$)
would enable $\Pr(\mu|\data)$ to be estimated such that the distance
uncertainty per object would be reduced by  20\% on average, and by 40\%
in regions of low convergence, leading to the suggestion that weak
lensing maps be used to identify the (low convergence)  lines of sight
that give higher precision distance estimates.

The \MS results have been used to analyse real observations as well. 
\citet{SuyuEtal2010} selected \MS lines of sight by their apparent
galaxy overdensity, in a 45 arcsec radius aperture down to $i < 24.5$,
to match the observed overdensity towards the time delay lens
B1608$+$656 \citep{FassnachtEtal2011}.  The resulting distribution of
$\kappa$ values from the ray-tracing was taken to be an estimate of 
$\Pr(\kappa)$, which was then marginalised over when inferring the time
delay distance in this system. 
% B1608$+$656 is indeed a high $\kappa$
% line of sight, but it does not reside in a massive cluster environment.
In a companion paper to this one, Greene et al (submitted) investigate
improvements to this method by weighting the galaxy counts by galaxy
mass, and perpendicular distance to the line of sight, again using the
\MS mock catalogs and their associated $\kappa$ values to construct
$\Pr(\kappa|\data)$.

In this paper, we combine the halo model reconstruction approach of
\citeauthor{GunnarssonEtal2006} and \citeauthor{WongEtal2011}, with the
idea of calibrating to simulations from \citeauthor{SuyuEtal2010}, in
order to put the halo model for  estimating the weak lensing convergence
due to mass along the line of sight to a distant source into a sound
framework for evaluating this important source of systematic
uncertainty, as we look forward to ever increasing sample sizes and
statistical precision. Taking the $\kappa$ values from
\citeauthor{HilbertEtal2009}'s ray-tracing calculations as the ``truth''
that we have to recover, we use the \MS mock galaxy catalogs first to
{\it calibrate} the reconstruction, and account for unseen mass and
voids, and then to {\it test} the accuracy of the line of sight mass
reconstruction under this assumption. Probabilistically assigning mass
and redshift to every observed galaxy in a given observed field, we
generate Monte Carlo sample line of sight mass distributions, and so
construct the PDF $\Pr(\kappa|\data)$ for that field. We then emulate
the combination of many such PDFs to quantify the residual biases that
would be translated to the global (including cosmological) parameters.
In doing so, we aim to answer the following questions: 

\begin{itemize}

\item Faint galaxies, filaments and dark structures will not appear in
any photometric object catalog, but they will contribute convergence at
some level. How much of the total convergence comes from visible
galaxies, and how much effect do dark structures and voids have? 

\item Can the true convergence be recovered from a calibrated halo model
reconstruction? What scatter and residual bias are induced by the
reconstruction process, and how might these be reduced in the future? 

\item We have some choices to make when planning follow-up observations
of interesting sightlines. How should we select objects to achieve the
highest accuracy convergence reconstruction? Can such a selection be
made robustly, using the reconstruction results?

\end{itemize}


This paper is organized as follows. We review the relevant gravitational
lensing theory in~\Sref{sec:theory}, and the Millenium Simulation
ray-traced convergences and mock catalogs in \Sref{sec:MS}, before
introducing our simple reconstruction  model in \Sref{sec:model}. We
then test this model in two phases: first, in \Sref{sec:knownMh+z}, with
known redshift and halo mass for every galaxy in a lens field, in order
to quantify the irreducible uncertainty due to unseen mass, and second,
in \Sref{sec:obsMstar+z}, with realistic observational uncertainties on
the observed galaxies' stellar masses and redshifts. In
\Sref{sec:biases} we investigate the potential systematic error induced
by selecting a subset of sightlines. We discuss our results in
\Sref{sec:discuss} before concluding in \Sref{sec:conclude}.

Throughout this paper magnitudes are given in the AB system and
we adopt the Millenium Simulation's ``concordance'' parameters for our reference cosmology, \ie
$h=0.73$, $\Omega_m=0.25$ and $\Omega_\Lambda=0.75$, where the symbols indicate
the Hubble Constant in units of 100 km s$^{-1}$ Mpc$^{-1}$ and the matter and
dark energy density of the Universe in units of the critical density.
.%\citep[e.g.\ ][]{KomEtal09}.



\begin{figure*}
\includegraphics[width=\textwidth]{figs/viewofalightcone.eps}
\caption[magcut]{Four different views of a slightly over-dense \MS line
of sight, with a $\kappa$ of 0.03. 
{\it Top row, left:} The positions of galaxies projected on the sky. The area
of the circles is proportional to observed $i$-band flux; the brightest
object shown has an $i$ magnitude of 17.7. 
{\it Top row, centre:} The angular sizes of halos projected on the sky.
Red and blue regions lie within the NFW scale radius and virial radius
of each halo, respectively. There are essentially no empty lightcones. 
{\it Top row, right:} The individual $\kappa$ contributions of
each halo, assuming the \citet{BMO} profile and the \citet{Neto2007}
mass-concentration relation. Comparison of
this panel and the centre panel reveals the relative importance of
proximity to the line of sight.
{\it Bottom:} A view along the redshift axis, showing only halos with
$|x|<0.3$ arcmin. The area of the points is proportional to each halo's
mass: the most massive halo shown has $1.6\times10^{12}\Msun$. The
optical axis is shown by the dashed line, while the dotted lines mark
the lens and source planes for a B1608-like strong lens.}
\label{fig:lightcone}
\end{figure*}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical Background}
\label{sec:theory}

Convergence, or Ricci focusing, occurs when a gravitational lens focuses
the rays in a given bundle. This focusing can cause distant objects to
appear brighter, and larger than they would if the lens were removed.
The convergence from an isolated mass sheet at a position
$\bmath{\theta}$ on the sky is the ratio of the projected surface
mass density ($\Sigma(D_{\mathrm{od}}\bmath{\theta})$) \devided by the
critical surface mass density at the redshift of the mass sheet
($\Sigma_{\rm cr}$),
\be
\kappa(\bmath{\theta})= \frac {\Sigma(D_{\mathrm{od}}\bmath{\theta})}
                              {\Sigma_{\rm cr}(\zd,\zs)}
\ee
where 
\be 
\label{eq:sigcrit} 
\Sigma_{\rm cr}(\zd,\zs) \equiv \frac{c^2 D_{\rm os}}{4 \pi G D_{\rm od} D_{\rm ds}}.
\ee
and the $D$'s are the angular diameter distances between the objects
refered to in the subscripts: o is the observer, d is the deflector and
s is the source. If the surface mass density of the sheet exceeds
$\Sigma_{\rm cr}$, multiple images of the source can occur, otherwise
only one image will be observed, although that image will still be
perturbed relative to the unlensed case.

\comments{
Strong lensing occurs when a massive object and background source are almost perfectly
aligned along a line of sight. The light from the background source is deflected by the
lens galaxy; this deflection allows multiple images of the background source to form
at stationary points of the time delay function. For an isolated lens, the time delay
function can be calculated from
\be \label{eq:T} 
\Delta t(\bmath{\theta},\bmath{\beta}) = \frac {1}{c} \frac{D_{\rm od} D_{\rm os}}{D_{\rm ds}} (1+z_{\rm d})\, \phi(\bmath{\theta},\bmath{\beta}),
\ee
where $\bmath{\theta}$ is the observed source position, $\bmath{\beta}$ is the 
unlensed source position, $z_{\rm d}$ is the redshift of the lens, $\phi(\bmath{\theta},\bmath{\beta})$ is
the Fermat potential. The Fermat potential is given by
\be \label{eq:FP}
\phi(\bmath{\theta},\bmath{\beta})\equiv \left[\frac{(\bmath{\theta}-\bmath{\beta})^2}{2}-\psi(\bmath{\theta}) \right], 
\ee
where $\psi(\bmath{\theta})$ is the lens potential, derived from the projected dimensionless
surface mass density, $\kappa(\bmath{\theta})$, by 
\be \label{eq:psikappa}
\kappa(\bmath{\theta})=\frac{1}{2}\nabla^2\psi(\bmath{\theta}).
\ee
}

Strong lenses sit in our real Universe -- they are not \truely isolated;
there is some mass along the line of sight coming from intervening
structures. These structures may be physically associated with the lens
e.g. other members of a group or cluster, or they may be the result of
chance alignments at any redshift.  Whilst it is rare for three galaxies
to line up well enough for both of the background sources to be strongly
lensed \citep{GavazziEtal2008,CollettEtal2012a}, the large size of dark
matter halos makes a partial alignment -- with the additional structure
acting as a perturbing weak lens --  a near certainty
\citep{Vale+White2003,HilbertEtal2007}. These additional structures
induce an external shear which can be recovered in the mass-modelling of
the lens, but they can also introduce a convergence that is undetectable
from the image positions, shapes and relative fluxes
\citep{FalcoEtal1985}.

If the intrinsic source brightness changes, the observed brightness in
each image does not change simultaneously: there will be a time delay,
$\Delta t$, between the brightness change in each image. Despite the
invariance of the image positions and fluxes, under the addition of an
external convergence (and appropriate re-scaling of the lens potential)
the relative Fermat potential between the images is {\it not} invariant,
and so the time delay changes. As such it is necessary to include
$\kappa$ in the lens modelling, if cosmological parameters are to be
estimated accurately and precisely from observed time delays
\citep{SuyuEtal2010}. Mass distributions that are physically associated with the lens galaxy
will affect the stellar dynamics of the lens galaxy, so that dynamical
observations can break the internal mass-sheet degeneracy by providing
an additional estimate of the lens galaxy's mass
\citep[e.g.,][]{SuyuEtal2010}. In this work our aim is to quantify the
lensing effect of massive objects, regardless of their position along
the line of sight.

If there is external convergence present that is not included in the
lens modeling, then the time delay distance -- inferred assuming $\kappa
= 0$ -- will be $(1-\kappa)$ less than the true value of $\Dt$:
\be 
\label{eq:MassSheet:Dtbias}
\Dt^{\rm{true}}=(1-\kappa) \Dt^{{\kappax = 0}}.
\ee
We can hence estimate the true distance if we have  with additional
knowledge of $\kappa$. Since $\kappa$ is typically small the absolute
uncertainty on the estimate of $\kappa$ \correspends to the fractional
uncertainty with which time-delay distances can be \infered.

The relationship between convergence $\kappa$ and magnification $\mu$ is
\bea 
\mu &=&       \frac{1}{(1-\kappa)^2 - |\gamma|^2}, \notag \\
    &\approx& (1+2\kappa)
\label{eq:MassSheet:mag}
\eea
where we have used the facts that the magnitude of the gravitational
shear at any point is typically comparable to the magnitude of the 
convergence, and that both are typically small. 
Under these assumptions, the fractional uncertainty in the
inferred luminosity of a magnified source will be approximately  twice
the absolute uncertainty in the convergence~$\kappa$. These
relationships will allow us to put our results on convergence estimation
in context.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Millenium Simulation}
\label{sec:MS}

In order to test the accuracy of our convergence estimates, we need to
know the true convergence for each line of sight. We cannot use  real
lines of sight for this,  but must use simulated lines of sight instead.
In this section we briefly review the Millenium Simulation, the ray
tracing calculations that have been carried out in it, and the mock
galaxy catalogs that have been produced.

The \MS \citep{SpringelEtal2005} is a cosmological N-body simulation of
Dark Matter structures in a cubic region approximately 680~Mpc in
comoving size, followed from redshift 127 to the present day. With an
approximate halo mass resolution of $2\times10^{10}{\rm M}_{\odot}$
(corresponding approximately to a galaxy with luminosity $0.1L^{*}$), it
provides a detailed prediction for the distribution of dark structures
present in the Universe, under the assumptions of the $\Lambda$CDM model
of hierarchical structure formation, cosmological densities as given at
the end of \Sref{sec:intro}, and $\sigma_8 = 0.9$. 
Galaxy properties,
such as stellar masses, luminosities and colours, were assigned to the
simulated halos according to a semi-analytic model for galaxy formation
\citep{DeLucia+Blaizot2007}: the resulting predictions for the galaxy
luminosity function and correlation function match the observational
data very well.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Convergence from Ray Tracing}
\label{sec:MS:raytracing}

\citet{HilbertEtal2009} calculated the lensing convergence using the
``lightcone'' dark matter only 
output of the \MS, providing 1.7 degree square 
mock sky maps of this
quantity. In this process, the dark matter density from the simulation
was projected onto a set of lens planes at discrete redshifts,
adaptively gridded and smoothed, and then the second derivatives of the 
lensing potential required for the components of the magnification
matrix were computed using a multiple lens plane ray tracing algorithm.
The first order approximation to this algorithm \citep[equation 17
of][]{HilbertEtal2009} gives the total convergence at a given sky
position~$\bmath{\theta}$ as the simple summation of the surface density
in each lens plane, weighted by the inverse critical surface density
$\Sigma_{\rm cr}$ for that plane's redshift:
\be
\kappa(\bmath{\theta}) = \sum_i \frac{\Sigma_i(\bmath{\theta})}
                                     {\Sigma_{\rm cr}(z_i,\zs)}.
\ee
This approximation was found to be accurate to a few percent or better
in $\kappa$, even on 30 arcsecond scales.

To define a test line of sight, we draw a random sky position from
within the convergence maps, bilinearly interpolate between the pixels
of the map, and store the result as the ``true'' convergence for that
line of sight, $\kappa_{\rm true}$. 

\todo{Stefan}{Check this is all accurate and complete!}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Mock Galaxy Catalogs}
\label{sec:MS:mocks}

Our goal is to recover the ``true'' convergence defined in the previous
sub-section, via an inference that takes a catalog of galaxy positions
and properties as data. We construct such catalogs by selecting all \MS
galaxies within a circular aperture of a given angular radius centred on
the line of sight position, with apparent $i$-band magnitude brighter
than a given limit. The parent catalog, from \citet{HilbertEtal2011},
contains galaxy positions and magnitudes, all of which include lensing
effects (deflections and magnifications). We also have access to the
underlying galaxy halo masses and redshifts, which we will use to
calibrate the reconstruction, and also to explore any sources of bias
and scatter. Since the true convergence is that of only the dark matter,
we focus on reconstructing the dark matter halos alone. Our model for
doing this is outlined in the next section. 

\todo{Stefan, Tom}{Check this is all accurate and complete!}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Estimating Convergence: The Halo Model Approximation}
\label{sec:model}

For real lines of sight, we would like to estimate the external convergence given all
data available. Typically this data is in the form of a photometric galaxy
catalog, containing positions, brightnesses, colours, and possibly spectra for each galaxy in the
field of the lens, down to some magnitude
limit. Since we can not observe the surface mass density of each halo
directy, we need some way of estimating
the mass of each halo in the catalog, so that we can compute its
contribution to the total $\kappax$ along the line of sight. This mass assignment recipe will be uncertain, but
can be calibrated with cosmological simulations.

Transforming the photometometric galaxy catalogue into a  catalogue of
halo masses, positions, and redshifts, will enable us to attempt a
reconstruction of the convergence induced by every halo near a line of sight.
This is the subject of Section \ref{subsec:halos}. We also need to account for
the mass in the Universe that is not associated with the galaxies we can see
-- this is the subject of Section \ref{subsec:voids}. 


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Halos}
\label{subsec:halos}

Cosmological dark matter simulations have shown that dark matter
halos are well approximated by NFW profiles \citep{NFW}, with a density
profile given by
\be\label{eq:rhonfw}
\rho(r) = 
\frac{\rho_0}{\left(r/r_{s}\right)
\left(1+r/r_{s}\right)^{2}},
\ee
where $r_{s}$ is a characteristic radius of the cluster, representing where
the density slope transitions from $r^{-1}$ to $r^{-3}$. This radius is related
to the virial radius of the halo by $r_{s}~=~r_{200}/c$, where $r_{200}$ is the radius at 
which 
\be
\rho(r_{200}) = 200\rho_{{\mathrm{crit}}}(z), \text{ where } \rho_{\mathrm{crit}}(z) \equiv \frac{3H^{2}(z)}{8\pi G}
\ee
and $c$ is the concentration parameter, which can be estimated from the halo's mass,
using a mass--concentration relation. Typically more massive halos are less concentrated,
but there is some scatter; we use the relation of \citet{Neto2007} to estimate $c$
from the mass enclosed within $r_{200}$, which we denote as $M_{200}$. We find our results do not change if the \citet{MaccioEtal2008} Mass--concencetration relation is used instead. The best fit relation of \citet{Neto2007} is given by
\be
c_{200} = 4.67 (M_{200}/10^{14} h^{-1} \Msun)^{-0.11}.
\ee
$\rho_0$ is calculated from the critical density and concentration parameter:
\be
\rho_0 = \rho_{\mathrm{crit}}(z)\frac{200}{3}\frac{c^{3}}{\ln(1+c)-c/(1+c)}.
\ee


Unphysically, if one integrates the density profile of an NFW profile, the total mass is divergent.
Similarly, if the universe is homogeneously populated with NFW halos, the projected surface mass along any
line of sight will also be divergant\footnote{At large radius, $\Sigma_{\rm
nfw} \propto R^{-2}$, but the differential number of halos centred within an
annulus of width $\dee R$ is given by $\dee N_{\rm annulus} \propto R \dee R$,
so  $\Sigma_{\rm total} \propto \int_{0}^{\infty} R^{-1} \dee R$, which
diverges logarithmically}. Since infinite mass is unphysical, the profile must
be truncated at some point. Several truncation profiles have been suggested \citep[e.g][]{BMO}, but beyond several virial radii, the amount of matter associated with a halo is likely to be low. In this work we assume the truncated NFW profile of \citet{BMO}
\be\label{eq:bmoprofile}
\rho(r) = 
\frac{\rho_{\rm NFW} (r)}{1+\left(r/r_{t}\right)^2},
\ee
which is the same as the NFW profile in the limit that the truncation radius, $r_t$ goes to infinity. We use a truncation radius of five times the virial radius, but our results are robust for any choice of $r_t>2 \times r_{200}$.

The projected surface mass density $\Sigma(r)$ for this mass profile is derived in \citet{BMO}. Each halo in our catalogue then contributes to the line of sight convergence by
\be
\label{eq:kappai}
\kappa_i =\Sigma_{i}/\Sigma_{\mathrm{cr}}(z_i,\zs),
\ee
where the critical surface density was defined in \Eref{eq:sigcrit}.
Following the first order approximation of \citet{HilbertEtal2009}
outlined in \Sref{sec:MS} above, we compute 
the total convergence from all the halos along the line
of sight using
\be 
\label{eq:kappasummu}
\kappah = \sum_{i} \kappa_i.
\ee

To estimate a halo's contribution to $\kappah$ we must first know the halo's mass.
For the calibration sightlines of the \MS halo masses are known, but for 
real lines of sight this can only be infered from the stellar masses of the
galaxies within a halo. We use the relation of \citet{BehrooziEtal2010} to generate 
halo masses from stellar masses; the details of this proceedure are outlined in
Appendix \ref{appendix:MSMH}.

Given an uncertain halo mass and redshift for a halo we draw a sample mass and redshift and use Equation \ref{eq:kappai} to generate a sample $\kappa_i$; this can be done for all the halos along the line of sight and summed to give a sample $\kappah$; repeatedly applying this proceedure allows us to characterize $\pr(\kappah)$. However we found that our proceedure for estimating halo masses induces long tails in the $\pr(\kappah)$ distribution that are not present in the global $\kappah$ distribution given perfect knowledge of halo mass and redshift, to correct for this we use the global $\kappah$ distribution as a prior on $\pr(\kappah)$.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Accounting for voids, filaments and dark structures}
\label{subsec:voids}

Whilst halos contribute a positive convergence to $\kappa$, voids contribute
a negative convergence. When a raybundle passes through a  region of space
that is less dense than $\rho_{\rm cr}(z)$ the rays are de-focused\footnote{In
principle, the convergence caused by halos, is also caused by the overdensity,
but we neglect this effect since halos are typically much more dense than the
intergalactic medium}. Whilst the  full raytraced solution takes into account
the effect of voids, our reconstruction cannot -- the halo catalogue does not
include voids. In principle the absence of a halo could be taken to infer a
void, but the under-density of such a void is hard to infer. Neglecting voids
would lead to a heavily biased estimate of $\kappa$. 

The proceedure outlined in Section \ref{subsec:halos} allows us to estimate 
the convergence due to halos given observations of mass, redshift and position
$\pr(\kappah|\mathcal{D})$, but what we are interested in is the total convergence
along the line of sight $\pr(\kappa|\mathcal{D})$. We can obtain this by
considering the expression:
\begin{equation}
\Pr(\kappa|\mathcal{D}) = \int \dee\kappah 
   \Pr(\kappa|\kappah) \Pr(\kappah|\mathcal{D})
\label{eq:kappaconv}   
\end{equation}
The first term in the integrand relates the summed convergence due to model
halos, $\kappah$, to the true convergence, $\kappa$. In the Millenium
Simulation catalogs, we can compute $\kappah$ for each
selected line of sight and combine multiple lines of sight to calculate $\Pr(\kappa|\kappah)$.

Given an uncertain stellar mass to halo mass conversion, the
$\pr(\kappah|\{\Mstar,z\})$ can shift  relative to
$\pr(\kappah|\{\Mhalo,z\})$; this is because of the highly asymetric
conversion from stellar mass through halo mass into $\kappah$. If this shift
is ignored the resulting $\Pr(\kappa)$ can become highly biased. To calibrate
this effect we reconstruct each of our calibration sightlines, in the same way
as the observed sightlines to generate $\pr(\kappa,\kappah|\{\Mstar,z\})$, for
each calibration sightline we use the median of $\pr(\kappah|\{\Mstar,z\})$ to
form a de-biased $\Pr(\kappa|\kappah)$.

For any given line of sight we can then infer
$\Pr(\kappah|\mathcal{D})$ as described above, and then
multiply it by $\Pr(\kappa|\kappah)$; we do the marginalisation over $\kappah$
by drawing samples from the two-dimensional grid and keeping only the
$\kappa$ values, to form our final result, $\Pr(\kappa|\mathcal{D})$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Calibrating the halo model}
\label{sec:knownMh+z} 

In order to test the reconstruction proceedure outlined in Section
\ref{sec:model}, we now apply it to mock galaxy catalogs generated in
regions on the sky around lines of sight with known
$\kappa$ in the Millenium Simulation. 

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How does $\kappah$ relate to $\kappa$?}

Given the halo mass catalogue from the Millenium Simulation, 
and convergence maps produced by ray-tracing through the MS's n-body particles, 
it is possible to test the validity of the prescription outlined
in Section \ref{sec:model}. In this section we test reconstruction prescription given perfect
knowledge of the halos' virial masses and redshifts; this provides us with a measure of the intrinsic uncertainty induced by treating matter as truncated NFW halos. 
We test the model by comparing $\kappah$ against
the ray-traced $\kappa$. If the reconstruction process is to be
succesfull the two quantities should be closely related, although
we expect $\kappah$ to be offset from $\kappa$ since the former 
does not include the divergence due to voids. Figure \ref{fig:isitbiased} shows that indeed $\kappah$ is a good estimator, regardless of the individual value of $\kappah$. At fixed $\kappah$ we find that the scatter in $\kapparay$ grows with $\kappah$; our reconstruction is better at reproducing underdense lines of sight than overdense lines of sight.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/cornerplot.eps}
\caption[Biased?]{$\kappah$ verses $\kappa$ for 100000 reconstructed lines of sight. $\kappah$ traces $\kappa$, but with a non-zero offset which is due to the negative convergence from voids. At fixed $\kappah$ the scatter in $\kappa$ grows with $\kappah$.}
\label{fig:isitbiased}
\end{figure}

%\subsubsection{How does $\gammah$ relate to $\gamma$?}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How succesful is the calibration at converting $\kappah$ into $\kappa$?}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/globaldist.eps}
\caption[magcut]{Comparison of the global P($\kappa$) from $10^{5}$ lines of sight to $10^{5}$ random samples drawn each from P($\kappax|\{M_{200},z\}$) for a reconstructed lines of sight. Red is the global P($\kappa$) and black is a histogram of the samples. Given perfect knowledge of halo mass and redshift the reconstruction appears to be correct globally.}
\label{fig:globaldist}
\end{figure}

\begin{figure*}
\includegraphics[width=\textwidth]{figs/where_is_the_kappa.eps}
\caption[magcut]{Which objects dominate the external convergence for a line of sight? From left to right the three figures show the cumulative contribution to convergence from indvidual halos as a function of distance from the line of sight, magnitude and redshift. The solid line is the median cumulative contribution, whilst dashed and dot-dashed show the 68 and 95 percent confidence intervals repectively. The majority of convergence comes from halos within the central 30 arcseconds. The convergence is dominated by halos with $i$ magnitudes between 20 and 24, halos brighter than 20 are rare, whilst fainter halos (at $z<1.4$) must be low mass, so can only contribute to the convergence if they are very close to the line of sight. Halos at all redshifts contribute to the convergence but the largest contribution comes from halos with $z \sim z_{\rm source}/2$.}
\label{fig:where}
\end{figure*}

Since voids are not included in the halo model approximation $\kappah$
is a biased estimator of $\kappa$, but this can be calibrated for useing
the proceedure of Section \ref{subsec:voids}. Taking the reconstructed
$\kappah$ for $1\times 10^{5}$ lines of sight we form the joint
distribution, P$(\kappa,\kappah)$ and marginalize over P$(\kappah)$ to
give P($\kappa$). We define the bias as the difference between the
expectation value of $\kappa$ and the known true value of $\kapparay$
for each Line of sight and we define the reconstruction width,
$\sigma_{\kappa}$,as half the width of the interval containing the
central $68\%$ of the probability P($\kappax$). From $1\times 10^{4}$
reconstructed lines of sight we find the the bias to have mean of
$-9.5\times 10^{-6}$ and a mean reconstruction width of 0.0132 which is
roughly 1.8 times smaller than the width of the global P$(\kappax)$. We
find that our $\kappa$ distributions are consistent with the global
$\kappa$ distribution; Figure \ref{fig:globaldist} shows that sampling
from $\pr(\kappa)$ for 100000 lines of sight is very similar to the
global $\pr(\kappa)$. Given perfect knowledge of halo mass and redshift,
the calibration proceedure provides an unbiased estimate of $\kappa$
that is $\sim$2 times as precise than using the global $\pr(\kappa)$.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Which halos dominate the $\kappah$ distribution?}

Before investigating the uncertainties caused by imperfect knowledge of
halo mass and redshift, we investigate the uncertainties induced by a
magnitude limited reconstruction and a field of view limited
reconstruction. The halos in our catalogue are populated by galaxies and
given magnitudes according to the semi-analytic model of
\citet{DeLucia+Blaizot2007} and by applying magnitude cuts to our
catalogue, we can investigate the scatter caused by unobserved halos.
The majority of the convergence comes from halos with an $i$ magnitude
between 18 and 24. \Fref{fig:where} shows the cumulative
contribution to $\kappah$ as a function of projected distance from the
line of sight, magnitude and redshift. Unsurprisingly we find that most
of the convergence comes from halos whose galaxies are close to the line
of sight. As a function of magnitude, we find that $\kappah$ is
dominated by objects with magnitudes between $i=18$ and $i=24$. Objects
brighter than $i=18$ are either too rare or too close to the observer to
make a significant contribution to the convergence. Objects fainter than
$i=24$ are too small to be important, unless they are extremely close to
the line of sight, but we find that including including halos fainter
than $i=24$ does not improve our reconstruction. Figure \ref{fig:magcut}
shows the scatter on $\kappah-\kappa$ (where $\kappah$ is shifted so
that it's mean is zero) as a function of reconstruction magnitude limit.
Since these objects must be extremely close to the line of sight to make
a non-zero $\kappah$ contribution it is likely that neglecting stellar
mass and using a spherical NFW prescription are too naive to adequately
reconstruct $\kappax$; thus we do not expect a deeper survey to decrease
the size of the uncertainty in mapping $\kappah$ onto $\kappa$. We find
that halos at all redshifts contribute to the convergence, but halos at
redshifts of $z \sim z_{\rm source}/2$ contribute the most.  

\begin{figure}
\includegraphics[width=\columnwidth]{figs/mag_scatter.eps}
\caption[magcut]{The 16, 50 and 84\% confidence intervals on $\kappah$ minus $\kappa$ as a function of the limiting $i$ band depth of the halo reconstruction. $\kappah$ has been shifted such that $\left\langle\kappah\right\rangle=0$. The majority of the constraining power comes from reconstructing halos with magnitudes between $18<i<24$.}
\label{fig:magcut}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Applying the Halo Model approximation to mock catalogs}
\label{sec:obsMstar+z}

Real attempts to reconstruct the convergence along a line of sight will not have direct access to the masses of dark matter halos, 
and will likely not have access to a spectroscopic redshift either. Instead these properties must be inferred from astrophysical
observables. In principle the only observables may be astrometric positions, photometric colours and possibly spectra. In this section we
quantify the errors induced by inferring the halo mass and redshift from the observables. Much work has already focused on using
photometric colours to infer stellar mass \citep[\eg][]{AugerEtal2009} and redshifts \citep[\eg][]{BPZ}, in line with these we shall use
stellar mass and photometric redshifts (with appropriate errors), as the observables that must be converted into an estimate
of $\kappax$. We will investigate two main sources of error: inferring halo mass given observed stellar mass and placing halos at the wrong redshift due to photometric redshift error.

We generate a stellar mass for each halo according to the stellar mass--halo mass relation of 
\citet{BehrooziEtal2010}. From this stellar mass we simulate 
an observed stellar mass by drawing a sample from $\pr(\log(M_{* \mathrm {obs}})|\log(M_{* \mathrm {true}}))$ which is given by a Gaussian of width $\sigma_{M_*}$ centred on $\log(M*_{\mathrm {true}})$. Where a spectroscopic redshift exists stellar masses can be estimated with typical uncertainties of 0.15 dex \citep{AugerEtal2009}, however with photometric redshifts stellar mass uncertainties are typically three times as large; we use $\sigma_{M_*}=0.15$ for halos with a spectroscopic redshift and $\sigma_{M_*}=0.45$ otherwise. For photometric redshift errors we draw a redshift from $\pr(z_{\rm true}|z_{\rm obs})$ which we take as a Gaussian of width $0.1(1+z_{\rm spec})$ centred on $z_{\rm spec}$, where $z_{\rm spec}$ is the halo's true redshift in the \MS catalogue.

Given an uncertain stellar mass and redshift it is possible to infer a
halo mass using the stellar mass--halo mass relation of
\citet{BehrooziEtal2010}. This proceedure requires an inversion of the
relation given in \citet{BehrooziEtal2010} and correctly inverting the
relation's uncertainties requires care: the proceedure we use to do this
is given in Appendix \ref{appendix:MSMH}. By drawing sample halo masses
and redshifts, we can infer a sample $\kappah$ using the proceedure of
Section \ref{sec:model}; repeatedly drawing samples allows us to
estimate P$(\kappah)$ for each reconstructed line of sight.

\subsection{Reconstructing $\kappa$ given a spectroscopic redshift for every object}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Width.eps}
\caption[magcut]{The widths of the infered P$(\kappah|\mathcal{D})$ for $10^5$ lines of sight given different amounts of data. Blue assumes a spectroscopic redshift for every halo with $i<26$, purple assumes a spectroscopic redshift for every halo with $i<23$ and every within 1 arcminute and $i<24$, cyan assumes a spectroscopic redshift for every halo with $i<22$ and green assumes that no objects in the field have a spectroscopic redshift}
\label{fig:reconwidths}
\end{figure}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Widthvshilberrt.eps}
\caption[magcut]{Width of the infered P$(\kappah|\mathcal{D})$ verses the true $\kappa$ along a line of sight. Blue assumes a spectroscopic redshift for every halo, whilst green assumes no spectroscopic redshifts. The width of the infered P$(\kappah)$ increases with $\kappa$. If correctly reconstructed, the lowest density lines of sight can provide the most precise measurement of the time delay distance.}
\label{fig:widthsvsH}
\end{figure}

The best possible reconstruction of $\kappah$ corresponds to having a sepctroscopic redshift for every single object in our field. Observationally such a reconstruction would be prohibitively expensive in terms of telescope time, but we investigate this scenario as an ideal case. Reconstructing the lines of sight with perfect knowledge of the redshift but an uncertain stellar mass, we find that the width of $\Pr\left(\sumkappah \right)$ grows with the expectation value of $\sumkappah$; this is not surprising since the low $\sumkappah$ lines of sight are relatively empty and so there are few opportunities for uncertainties in the halo masses to propogate into $\sumkappah$ uncertainties. After applying the void correction the median reconstruction width is 0.0123; with 22 percent of lines of sight having a reconstruction width less than 0.01. 

\subsection{Reconstructing $\kappa$ from photometry alone}

Inferring the stellar mass of a galaxy from its magnitude and colours requires an estimate of how far away the galaxy is; without a spectroscopic redshift the the infered stellar mass is less precise. However, obtaining photometry has much lower observational cost; over the next few years several large area photometric surveys will reach 24th magnitude \citep{EUCLID,LSST}, these will provide sufficient data to reconstruct lines of sight {\it without} additional observations. In principle the photometric redshift is correlated with the infered stellar mass, however we do not model this effect since the convergence from the outskirts of an individual halo is only weakly dependant on redshift at fixed mass: the redshift error is small effect on the recovered $\pr(\kappa)$ when compared to the effect of uncertain stellar masses.  With only photometric redshifts the uncertainty on $\sum\kapparec^{\rm halos}$ is much larger than the spectrocopic case and this propogates into a broader $\pr(\kappa)$, although the photometric reconstruction still typically produces a 1.4 fold improvement compared to the precision of the global P($\kappa$).

\subsection{Reconstructing $\kappa$ with partial spectroscopic coverage}

Whilst a fully photometric reconstruction provides useful constraints on $\pr(\kappa)$, targeted spectroscopy can provide addtional constraints upon the masses and redshifts of halos whose $\kappah$ contribution have the largest absolute uncertainty. Obtaining spectra of bright ($i<22$) objects is relatively fast with 8-m class telescopes; we find that if spectroscopic redhsifts were known for all $i<22$ galaxies in our field the reconstruction improves slightly upon the purely photometric reconstruction, although the improvement depends strongly upon the nature of the particular line of sight. Obtaining spectra for fainter objects would be considerably more expensive, but if spectroscopic redshifts could be obtained for all $i<23$ galaxies and all $i<24$ galaxies within 1 arcminute of the line of sight the $\pr(\kappa)$ would be almost as good as having complete spectroscopic coverage. High $\kappa$ lines of sight benefit the most from additional spectral coverage, since these LoS have the most uncertain $\kappah$. Consistent with our previous findings the lowest $\kappa$ lines of sight have the most constrained $\kappa$ PDFs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Testing for Systematic errors}
\label{sec:biases}
\begin{figure*}
\includegraphics[width=\textwidth]{figs/biasplots.eps}
\caption[magcut]{Estimating $\kappa-\kappa_{\rm true}$ from subsets of
lenses. By subtracting the true (ray-traced) convergence from the
infered P($\kappa$) for each line of sight we are left with a PDF that
should be estimating zero, these can be multiplied together for multiple
lines of sight to test for a possible bias. These plots show the
expectation value of $\prod_{i=1}^N \pr_i(\kappa-\kappa_{\rm true})$ -
deviations from zero can be seen as a bias. The solid, dashed and dotted
lines are for combining 20, 5 and 2 lenses respectively. Green lines are
from multiplying P($\kappa$) infered from photometry alone, whilst red
lines are from multiplying P($\kappa$) infered from photometry and a
spectroscopic redshift for all halos with $i<23$ and all halos within 1
arcminute and $i<24$. The left most plot shows randomly selected lines
of sight. The central plot shows sight lines randomly selected from the
third of lines whose P($\kappa$) is most tightly constrained. The right
hand plot shows only lines of sight with external shear of 0.03 or
greater.}
\label{fig:biasplots}
\end{figure*}

Whilst it is good to reconstruct $\kappa$ precisely it is vital that $\kappa$ is reconstructed accurately. A precise, inaccurate $\kappa$ estimator is worse than useless for cosmology. We test the accuracy of our reconstructed $\pr(\kappa)$ in the following way: for each line of sight we shift the reconstructed $\pr(\kappa)$ by the line of sight's raytraced $\kappa$ to give $\pr(\kappa-\kapparay)$. Since the $\pr(\kappa-\kapparay)$ for each line of sight is an independant estimator of zero, the PDFs can be combined according to

\be
\label{eq:bias}
\mathcal{P}_N=\prod_{i=1}^N \pr_i(\kappa-\kappa_{\rm true})
\ee

We quantify the bias as the size of the deviation in the expectation value of $\mathcal{P}$ from zero. If the bias of $\mathcal{P}_N$ is typically smaller than the half-width of $\mathcal{P}_N$ our $\kappa$ estimators can be considered accurate. The number of useful time delay lines of sight can be approximated as the point at which the modulus of the bias and width of $\mathcal{P}_N$ are the same size.

%\todo{tom}{do}
%\subsection{Using the wrong M$_{\rm halo}$-M$_{*}$ relation}
\subsection{Selection bias from a subset of lines of sight?}

First we test for systematic errors in the reconstruction of a randomly
selected subset of samples. With the purely photometric reconstruction
there is a small bias towards underestimating $\kappa$,  combining 6
lenses the half-width and bias of $\mathcal{P}_{6}$ both equal 0.007.
With targeted spectroscopic follow up this improves slightly, for the
combination of 8 lenses the half-width and expectation value 
$\mathcal{P}_{8}$ equal 0.005. Since strong lens modelling uncertainties
are typically at the 3\% level, several hundred lenses are needed to
reach this level of precision, but at that point a 0.005 bias in
$\kappa$ estimation would become the limiting factor on time-delay
cosmography.


\subsubsection{Selecting only the lines of sight with tight $\pr(\kappax)$}
\label{sec:tightPDF}

Since lens monitoring campaigns are expensive, it is likely that only a
subset of lenses will be observed. By pre-selecting the lenses with the
most well constrained $\pr(\kappax)$, the cosmological value per lens
can be increased, however this has the potential to induce a bias. It is
probable that only photometry will be available at the time of lens
selection (although spectroscopic follow-up might be conducted at a
later date). We mimik such a selection by drawing lines of sight only
from those in the lowest third of $\sigma_{\kappa}$ given a photomtric
reconstruction of their fields. We find that selecting the most tightly
constrained lines of sight {\it decreases} the bias - our reconstruction
is most succesful for the lowest $\kappa$ lines of sight. With
photometry alone the bias is at the 0.0028 level. With a targeted
spectroscopic follow-up of the selected lines of sight there is
negligible improvement, since the best constrained lines of sight are
the most empty, but it is the high-$\kappa$ lines of sight that benefit
the most from spectroscopy. Photometry of the field is sufficient to
adequately select the best lines of sight for cosmology - and doing so
greatly increases both the precision and accuracy of the cosmological
constraints per lens.

\subsubsection{Selecting only high shear lines of sight}
\todo{phil}{Write up why lenses are likely to be gamma biased}
\notes{The uncertainties from modeling a strong lens system depends on
the comfiguration of the source images. With only two point images ofthe
source the lens slope and mass are degenerate; the mass-slope
degeneracy\citep[need citation][Saha?]{mass-slope degeneracy}. Where lensed arcs or
four point images are present the mass-slope degeneracy can be broken
and cosmology can be extracted, \citep{Suyu2012a}. The detectability of
arcs depend on the source, but the presence of four images (so called
quads) depend on the shear of the lens model - a high shear is needed to
produce a quad. The shear is almost certainly dominated by the lens
model itself, but it is possible that quads are biased towards high
external shear.} 

By selecting only lines of sight with an external shear of $\gamma>0.03$ we can test the effect of shear selection. We find that in all cases $\kappa$ is underestimated at the $\sim$0.01 level. Part of this effect is mitigated if only the lines of sight with both $\gamma>0.03$ and sharp $\pr(\kappax)$ are used but biases at the $\sim$0.005 level remain. Since our model does not include shear constraints it is not surprising that selecting based on shear can induce a bias. A more sophisticated model that includes the shear recovered from the lens modelling may not be susceptable to this bias. The toy model of this section ($\gamma>0.03$) is likely to be a much stronger selection than reality, but it is worth noting that the reconstruction proceedure will be biased if lens selection functions are extreme and unaccounted.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\section{Improving precision by including additional information}
%\notes{placeholder for shear}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discuss}

We have shown that reconstructing the matter due to halos along any line of sight can improve the constraints on the external convergence along that line of sight. The total convergence along a line of sight is strongly correlated with the reconstructed $\kappah$. However since our model ignores voids and assumes all halos follow a spherical truncated-NFW profile our model does not include all of the relevant physics, hence the width of our resulting $\pr(\kappax)$ is still typically $\sim$0.01 for any given lightcone, even with a perfect knowledge of every halo's virial mass and redshift. To make further progress a more advanced treatment of both voids and halos will be necessary. Interestingly, we have found that the most empty lines of sight can be reconstructed with the most precision. $\kappax$ for empty lines of sight have little contributions from halos and a large contribution from voids; since they have the tightest PDFs after the reconstruction it seems that our model's biggest uncertainties are driven by naively reconstructing halos rather than neglecting voids. With a photometric reconstruction of the field there is a significant broadening but the resulting precision is still typically 1.5 times greater than using the global $\kappa$ distribution. 

Since the uncertainty on $\pr(\kappa|\mathcal{D})$ is $\sim$0.01 even with perfect knowledge of halo mass and redshift it seems that voids (plus deviations from sphericity and dark matter clumping within the main halo) dominate the total $\kappa$ uncertainty even with very uncertain stellar masses. Inferring halo ellipticity and dark matter clumping will likely always remain a difficulty for line of sight reconstruction; but as Figure \ref{fig:magcut} shows observing deeper than 24th magnitude does not signifcantly help the reconstruction. Because our reconstruction is mostly limited by the model, spectroscopic coverage can only provide a modest improvement to the reconstruction and at significant observational cost.

For a small fraction of lines of sight, $\pr(\kappax)$ remains very broad even after applying our reconstruction; these lines of sight are typically the most overdense lines of sight in the universe. For time-delay cosmography the most observationally expensive task is the lightcurve monitoring, whilst making photometric observations of a 4$\times$4 arcminute patch of sky survey down to 24th magnitude is a relatively cheap. We have shown that with a single epoch observation of the region around a strong lens it is possible to infer $\pr(\kappax)$. If a line of sight has a broad $\pr(\kappax)$ it can be rejected {\it before} the investment of longterm lightcurve monitoring. We find that selecting only the lines of sight with the most tightly constrained $\pr(\kappax)$ does not induce a bias.

The method we have outlined can also be used to estimate the external shear
along a line of sight. Shear is an observable that can be extracted from
strong lens modelling, however there is a degeneracy between internal and
external shear. Progress has been made in disentangelling external and
internal shear \citep[\eg][]{xxx} but there are still significant
uncertainties: \citet{WongEtal2011} attempted to match the shear from strong
lens models with a reconstruction of the local lens group environment, but
found a tension between the strong lens model and the reconstruction of the
environment. Since \citet{WongEtal2011} only reconstructed the local lens
group, rather than the full line of sight contribution, it is unclear whether
the external shear from lens models can be reconciled with a line of sight
reconstruction. {\it If} external shear can be measured, it provides an
additional constraint on which of the Millenium Simulation lines of sight are
similar to the reconstructed line of sight. \citet{SuyuEtal2012} found that
for RXJ1131 combining shear constriants with galaxy number count overdensity,
gave a significantly different $\pr(\kappax|\gamma,N_{45})$ copmpared to the
PDF from number count overdensity alone, $\pr(\kappax|N_{45})$. Whilst not included
in this paper, we found that given perfect knowledge of the halo mass and redshift
the raytraced external shear $\gamma$ and the reconstructed external shear $\gamma_{\mathrm{h}}$ 
are similar, with 68 percent of lines obeying
\be
\label{eq:shearineq}
|{\boldmath{\gamma}-\boldmath{\gamma_{\mathrm{h}}}}| < \mathrm{0.025}
\ee 
Future work should investigate whether $\gamma_{\mathrm{h}}$ can be used to improve
the accuracy and precision of $\kappa$ estimation, given a reconstruction
 of the line of sight. 

This work has used the \MS as a calibration guide. If the real universe is not like 
the \MS the the calibration will be incorrect - repeating the study with a different
simulation would quantify the sensitivity of our results to the simulation used. Similarly
the use of a different semi-analytic model to paint galaxies onto halos could provide
a useful check, to ensure against potential systematic errors.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
\label{sec:conclude}

In this work we have investigated a simple halo model prescription for
reconstructing all the mass along a line of sight to an intermediate redshift
source. We have used the ray-traced lensing convergence along lines of sight
through the Millenium Simulation to test this approach, and to calibrate
estimates of the total convergence along a line of sight to an observed
distant galaxy made by summing the convergences due to each object in a
photometric catalogue. Having found that the reconstruction process is effective given perfect
knowledge of halo mass and redshift, we investigated the effects of reasonable
uncertainties in the stellar mass and redshift of each halo, and propogated
these uncertainties into a $\pr\left(\sumkappah\right)$ for each line of
sight. We draw the following conclusions:

\begin{itemize} 

\item Our model uses a truncated spherical NFW profile for
each dark matter halo and neglects voids, but despite the model's simplicity
the reconstructed $\kappah$ is a good tracer of $\kappa$.  We found that
with perfect knowledge of the halo mass and redshift (from the Millenium
Simulation catalogs), for a typical line of sight the reconstruction
gives an unbiased estimate of $\pr(\kappa)$ that is a factor of 2
less broad than the global $\pr(\kappa)$.

\item  For the most overdense lines of sight, the reconstruction produces a
very broad PDF, but since the reconstruction can be performed before follow-up
time is invested it will be possible to discard the most uncertain lines of
sight and optimize the use of follow-up time. Photometric data is sufficient 
to select the best lines of sight for follow-up.

\item With uncertain halo masses and redshifts, we find that
$\pr(\kappah)$ is still a useful indicator for generating an estimate
of $\pr(\kappa)$ from the ensemble of simulated lines of sight, but the resulting
PDFs tend to be much broader than for perfect
halo mass and redshift reconstructions. Spectroscopic coverage helps to tighten 
$\pr(\kappa)$ for high $\kappa$ lines of sight, but is of limited use for 
low $\kappa$ lines of sight.

\item It is very rare for halos further than 2 arcminutes to make a
significant contribution to $\kappa$. We also found that including halos
whose host galaxy is less luminous than $i=24$ does not significantly improve
our reconstruction proceedure. A photometric survey to this depth of a
4$\times$4 arcminute patch around the lens would approach the limiting
uncertainties of our simple reconstruction recipe, and yield a 
$\pr(\kappa)$ that has, on average, a width of 0.016 --
1.5 times less broad than the global $\pr(\kappa)$.

\item We find that the lines of sight with the sharpest $\pr(\kappa)$ are
typically under-dense. With a photometric reconstruction of all lens fields,
and following up only the lenses with the sharpest $\pr(\kappa)$,
the width of the dominant statistical uncertainty in time-delay cosmography
can be halved, without inducing biases at the one percent level.

\end{itemize}

External convergence is not the only uncertainty in time delay cosmology,
but for systems like B1608 it is the dominant one. For most lines
of sight it is likely that lens modelling induces uncertainties at the
$\sim$3 percent level, which far exceeds the typical $\kappa$ uncertainties
after applying our reconstruction proceedure. By using our method to
reconstruct lines of sight and select which lense are followed-up, the
uncertainties due to line of sight convergence will become a sub-dominant 
source of error.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgments}
 
We thank Vasily Belokurov, Risa Wechsler and Peter Behroozi 
for useful discussions and suggestions.
\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Inferring $\Mhalo$ given a noisy measurement of $\Mstarobs$}
\label{appendix:MSMH}

To estimate the convergence caused by a halo we need to know its mass; how can 
halo mass be infered from a noisy estimate of the stellar mass $\Mstarobs$
of a galaxy at redshift $z$. We seek the posterior
PDF $\Pr(\Mhalo|\Mstarobs,z)$, which can be expanded as follows:

\begin{eqnarray}
&& \Pr(\Mhalo|\Mstarobs,z) = \notag\\
&& \int d\Mstar \Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|\Mstarobs,z), \notag\\
&\propto& \int d\Mstar \Pr(\Mstarobs|\Mstar) \Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z),
\label{eq:mhalo-mstar}
\end{eqnarray}
where we have used Bayes' Theorem twice to replace
$\Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|z)$ with 
$\Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z)$, and 
to invert $\Pr(\Mstar|\Mstarobs)$ into the sampling
distribution $\Pr(\Mstar|\Mstarobs)$, which we recognise as the likelihood
function for the observed stellar mass. Note that the ``true'' $\Mstar$ of the
galaxy is marginalised out: we are only interested in infering the halo
mass. The last two terms in
\eqref{eq:mhalo-mstar} are the $\Mstar-\Mhalo$ relation from
\citet{BehrooziEtal2010}, and the halo mass function $\Pr(\Mhalo|z)$, at the
given redshift. We can
tabulate the product of these two from our Millenium Simulation catalog,
constructing a two-dimensional histogram of halo masses and their associated
true stellar masses (drawn from the Behroozi relation). 

For each galaxy, we compute the likelihood function for its $\Mstarobs$ as a
function of the unknown $\Mstar$, and multiply it by our tabulated joint PDF.
This heavily downweights halos with $\Mstar$ values outside the observed
range. We then do the marginalisation integral by Monte Carlo, drawing
(two-dimensional) sample parameter vectors
from the downweighted histogram, discarding the $\Mstar$ values, and
constructing a one-dimensional histogram that is an estimate of
$\Pr(\Mhalo|\Mstarobs)$.

If the redshift of the galaxy is uncertain, we need to take this uncertainty
into account; for example, for each sample drawn from the photometric redshift
posterior PDF $\Pr(z|{\rm colors})$, we can draw a sample $\Mhalo$ using the
above procedure.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:

% bubble -f paper-lcr.tex references.bib 
% \input{paper-lcr.bbl}

% \bibliographystyle{apj}
% \bibliography{references}

\input{references.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{lastpage}
\bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
