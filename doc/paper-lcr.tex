%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pangloss: Testing the reconstruction paper
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

% \voffset=-0.8in

% Packages:
\input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}

% Macros:
\input{macros.tex}
\input{addresses.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Line of Sight Mass Reconstruction]
{Inferring Lensing Mass in the Universe \\
from Photometric Catalog Data}
    
\author[Collett \etal]{%
  Thomas~E.~Collett$^{1}$\thanks{\collettemail},
  Philip~J.~Marshall$^{2}$,
  Matthew~W.~Auger$^{1}$,
  Stefan~Hilbert$^{3}$,
\newauthor{%
  Sherry~H.~Suyu$^{4}$,
  Zachary~Greene$^{4}$,
  Tommaso~Treu$^{4}$\thanks{\packard},
  Christopher~D.~Fassnacht$^{5}$,}
\newauthor{%
  L\`eon~V.~E.~Koopmans$^{6}$,
  Roger~D.~Blandford$^{3}$} 
  \medskip\\
  $^1$\ioa\\
  $^2$\oxford\\
  $^3$\kipac\\
  $^4$\ucsb\\
  $^5$\davis\\
  $^6$\kapteyn
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2012}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract} 

Strong gravitational lenses can provide high precision cosmological distance
measurements; one of the most important sources of systematic error in these
estimates is the additional mass along the line of sight to the source. Weak
lensing by galaxies and groups in this beam can contribute an ``external
convergence'' $\xkappa$ that dominates the  uncertainty in the inferred
distances; likewise, it may also contaminate estimates of the luminosity of
objects at high redshift (such as reionisation-era proto-galaxies, and type Ia
supernovae standard candles).  We characterise this uncertainty by marginalising
over a probability density function for $\xkappa$: here, we investigate the use
of a simple halo model to estimate $\Pr(\xkappa)$ given noisy estimates of the
photometric redshift and stellar mass of galaxies observed in optical imaging
surveys of the field in question. Tests using mock catalogs from the Millenium
Simulation and comparing to ray-traced $\kappa$ values, we find that \ldots 
The $\Pr(\xkappa)$ from this reconstruction process are narrower than the
expected distribution of $\xkappa$ values over an ensemble of time delay lenses:
incorporating the photometric catalogs in a joint analysis of 100 lenses 
leads to an increase in precision of factor of 1.X over simple averaging. We
investigate several sources of bias and determine \ldots
\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing   --
  methods: statistical    --
  galaxies: halos         --
  gaaxies: mass function  --
  cosmology: observations
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}

Averaged over large areas of sky, the weak gravitational lensing effect can be
used to constrain the statistical properties of the matter density in the
Universe: every distant object we observe has had its shape distorted, and size
and total brightness magnified (or demagnified) by a compound lens constructed
from all the mass distributed between us and it.

This fact makes gravitational lensing a potentially important source of
systematic error for any estimate of luminosity or distance, an issue addressed
for \eg type Ia supernovae by \citet[][]{Holz+Wald,Linder+Holz} and for high
redshift galaxies by \citet{Loeb} among others. In time delay lens cosmography
the effect can be particularly important. \citet{Suyu2010} found that  the
lensing effect of mass structures along the (unusually over-dense)  line of
sight to the quadruply-imaged radio source B1608$+$656, the so-called ``external
convergence,'' was the dominant source of uncertainty in the inferred
cosmological parameters. 

How can we correct for the line of sight lensing error, and make accurate
measurements through the Universe? As \citeauthor{LH} noted, when inferring
global quantities (such as the cosmological parameters), averaging the results
from a large number of independent objects will tend to reduce the error, as the
ensemble-averaged convergence approaches zero for an unbiased sample
\citep{xxx}. If the sample is biased, however, some residual systematic error
will remain while the statistical uncertainty decreases -- and this will be the
case for any sample selected by the brightness of the lensed object, or any
other quantity that depends on $\xkappa$. The latter class includes time delay
lenses, which are detected based on the separation of their images, which
increases with $\kappa$. Large samples of lenses are expected to be discovered
in the next decade in ground-based optical imaging surveys
\citep{Oguri+Marshll2010} -- but these samples will be image separation-limited,
due to the surveys' relatively poor ($\sim 1$~arcsec) image quality. Some of the
current sample of known time delay lenses were detected in surveys like this: we
might expect them to be somewhat biased towards high values of $\xkappa$.

There are two broad approaches one could take at this point. First, one could
seek to characterise the lensed objects' selection function, and use this
understanding to derive a suitable correction to cosmological parameters
inferred assuming no $\xkappa$ at all. To do this, one needs information about
the unlensed population of objects, and the population of lenses, and how the
objects were detected -- or to infer these hierarchically during the analysis.
Alternatively, one could simply accept all lenses provided, regardless of their
selection, and try to use any additional information that is available to
estimate the external convergence in each system on a case by case basis, and
hence optimize their joint analysis to produce a better-constrained result. In
this work we follow the second approach, and use measurements of the positions,
magnitude and colours of galaxies close to time delay lens lines of sight to try
to infer the external convergence at the lens position. 

Previous attempts at reconstructing the line of sight mass distribution in
strong lens fields have focused on spectroscopic surveys to ascertain group
membership, and on understanding the external shear apparently required by the
strong lens models.  The probability density function (PDF) $\Pr(\xkappa)$ is
the target for any reconstruction analysis, and the key quantity for any
ensemble analysis, since by marginalising over it we can correctly propagate
the uncertainties due to weak lensing by line of sight mass structure. 
\flag{More needed here. Previous work on environments: Keeton, Zabludoff,Auger, Momcheva, Wong, others.}
Most recently, \citet{Wong++2011} ran Monte
Carlo reconstructions of the mass in nine lens fields, and compared the
resulting predicted shear distributions with the lens model external shear.
Their simulations show most of  the shear being generated by bright galaxies
within 2~arcminutes of the lens, and that both line of sight structures and
the group of galaxies in each lens plane contribute significant proportions of
the shear. The significant discrepancies between the lens model shear and the
Monte Carlo predictions are attributed to both the environment modelling and
the strong lens modelling itself.

These observational investigations have provided very useful insight into the
problem.  Coming from the opposite direction, large numerical simulations have
been used to predict, from first principles the distribution of likely
external shears and convergences along strong lens lines of sight. \flag{More
needed here. Holder \& Schechter, Dalal \& Watson}. \citet{Hilbert++2009}
performed ray-tracing experiments through the Millenium Simulation, generating
a predicted $\xkappa$ at every position in a simulated sky. The first step
towards using this excellent calibration resource was taken by
\citet{Suyu++2010}, who selected Millenium lines of sight that a) were found
to contain a strong lens and b) had comparable apparent galaxy overdensity in
a 45 arcsec radius aperture down to $i < 24$. This overdensity could be
compared to the overdensity of the B1608$+$656 line of sight
\citep{Fass+Koop2010}, and hence an estimate of  $\Pr(\xkappa)$ could be
made. 

What has not been investigated before, but is the subject of this paper, is
the use of simulations to {\it calibrate} lightcone reconstruction methods.
Ray-tracing through the simulations gives a ``truth'' that we can attempt to
recover.  In this paper we use the Millenium Simulation mock galaxy catalogs
and ray-traced lensing effects to test the accuracy of line of sight mass
reconstructions. Probabilistically ssigning mass and redshift to every
observed galaxy in the field around a time delay lens, we generate Monte Carlo
sample line of sight mass distributions, and estimate the external convergence
due to each one. This gives us a $\Pr(\xkappa)$ that can be propagated into
further joint inferences. We focus on time delay lens cosmography, and
quantify our results in terms of the uncertainty on the mean time delay
distance to a test sample of $N$ lenses (where for clarity each lens has the
same deflector and source redshift, and the same lens model and time delay
uncertainty).

We aim to answer the following questions:
\begin{itemize}
\item Faint galaxies and other dark structures will not appear in a photometric
object catalog, but they will contribute convergence at some level. How much of
the total external convergence in a time delay lens system comes from visible
galaxies? How does this change as a function of magnitude cut? 
\item Can the true (ray-traced) convergence be recovered by halo model
reconstruction? What scatter and residual bias are induced in the ensemble 
distance estimate? Which aspects of the model dominate these uncertainties? 
\item When faced with a newly-detected lens, surrounded by galaxies on the sky,
we have some choices to make when planning follow-up observations.
Which are the most important galaxies, with regard to the external convergence
produced? Can nearby groups and clusters be straightforwardly accounted for? If
lenses with such massive structures nearby are discarded, what impact does that
have on the distance accuracy?
\end{itemize}

This paper is organized as follows. In~\Sref{sec:theory} we review the relevant
gravitational lensing theory, before introducing our simple reconstruction 
model in \Sref{sec:model}.  We then test this model in two phases: first, in
\Sref{sec:knownMh+z}, with known redshift and halo mass for every galaxy in a
lens field, in order to quantify the irreducible uncertainty due to unseen mass,
and second, in \Sref{sec:obsMstar+z}, with realistic observational uncertainties
on the field galaxies' stellar masses and redshifts. We then propagate all these
uncertainties through to the time delay distance in a toy sample of 100 lenses,
in \Sref{sec:distances}. We discuss our results in \Sref{sec:discuss} before
concluding in \Sref{sec:conclude}.

Throughout this paper magnitudes are given in the AB system \citep{Oke74} and
we adopt the Millenium Simulation's ``concordance'' parameters for our reference cosmology, \ie
$h=0.73$, $\Omega_m=0.25$ and $\Omega_\Lambda=0.75$, where the symbols indicate
the Hubble Constant in units of 100 km s$^{-1}$ Mpc$^{-1}$ and the matter and
dark energy density of the Universe in units of the critical density
.%\citep[e.g.\ ][]{Kom++09}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical Background}
\label{sec:theory}

%Time delay distances, and the mass sheet degeneracy - how kappa is degenerate in
%strong lens models (and magnifications).


Convergence, or Ricci focusing, occurs when a gravitational lens focuses the rays in a raybundle.
This focussing can cause distant objects to appear brighter, and larger than they would if the lens
 were removed.
The convergence from an isolated mass sheet is the ratio of the projected surface mass density
($\Sigma(D_{\mathrm{od}}\bmath{\theta})$) devided by the critical surface mass density at the redshift of the mass sheet ($\Sigma_{\rm cr}$),
\be
\kappa(\bmath{\theta})= \frac {\Sigma(D_{\mathrm{od}}\bmath{\theta})}{\Sigma_{\rm cr}(z)}
\ee
where 
\be \label{eq:sigcrit} 
\Sigma_{\rm cr}(z) \equiv \frac{c^2 D_{\rm os}}{4 \pi G D_{\rm od} D_{\rm ds}}.
\ee
and the D's are the angular diameter distances between the objects refered to in the subscripts: o is the observer, d is the deflector and s is the source. If the surface mass density of the sheet exceeds $\Sigma_{\rm cr}$, multiple images of the source can
occur, otherwise only one image will be observed, although that image will still be perturbed
relative to the unlensed case.

Strong lensing occurs when a massive object and background source are almost perfectly
aligned along a line of sight. The light from the background source is deflected by the
lens galaxy; this deflection allows multiple images of the background source to form
at stationary points of the time delay function. For an isolated lens, the time delay
function can be calculated from
\be \label{eq:T} 
\Delta t(\bmath{\theta},\bmath{\beta}) = \frac {1}{c} \frac{D_{\rm od} D_{\rm os}}{D_{\rm ds}} (1+z_{\rm d})\, \phi(\bmath{\theta},\bmath{\beta}),
\ee
where $\bmath{\theta}$ is the observed source position, $\bmath{\beta}$ is the 
unlensed source position, $z_{\rm d}$ is the redshift of the lens, $\phi(\bmath{\theta},\bmath{\beta})$ is
the Fermat potential. The Fermat potential is given by
\be \label{eq:FP}
\phi(\bmath{\theta},\bmath{\beta})\equiv \left[\frac{(\bmath{\theta}-\bmath{\beta})^2}{2}-\psi(\bmath{\theta}) \right], 
\ee
where $\psi(\bmath{\theta})$ is the lens potential, derived from the projected dimensionless
surface mass density, $\kappa(\bmath{\theta})$, by 
\be \label{eq:psikappa}
\kappa(\bmath{\theta})=\frac{1}{2}\nabla^2\psi(\bmath{\theta}).
\ee

Strong lenses sit in our real Universe -- they are not truely isolated;
there is some mass along the line of sight coming from intervening structures.
These structures may be physically associated with the lens e.g. other members
of a group or cluster, or they may be the result of chance alignments at any redshift. 
Whilst it is rare for three galaxies to line up well enough for both of the background sources
to be strongly lensed \citep{gavazzi2008,collett2012}, the shear scale of dark matter halos
makes a partial allignment -- with the additional structure acting as a weak lens -- 
a near certainty, indeed \citet{valewhite2003} and \citet{hilbert2007} find that there
are no empty lightcones in a realistic universe. These additional structures induce an external shear
which can be recovered in the mass-modelling of the lens, but they can also introduce a convergence that
is undetectable from the image positions, shapes and relative fluxes; {\it the mass sheet-degeneracy} \citep[see e.g.][for details]{Falco1985,Schneider2006}.


If the intrinsic source brightness changes, the observed brightness in each image does not change
simultaneously - there is a time delay, $\Delta t$, between the brightness change in
each image. Despite the invariance of the image positions and fluxes, under the addition
of an external convergence (and appropriate re-scaling of the lens potential) the relative Fermat potential between the images is {\it not}
invariant, and so the time delay changes. As such it is necessary to include $\kappax$
in the lens modelling, if cosmological parameters are to be estimated accurately and
precisely from observed time delays \citep{suyu2010}.


If the mass sheet is not physically associated with the lens galaxy, it can lie at any redshift. The effects of such a mass-sheet can be projected back onto the lens plane in the form of an effective convergence. We define this effective convergence in two limits.
\begin{itemize}
\item No significant perturbations along the line of sight, and \\
\item A single dominant perturber, relative to which all other perturbations are small.
\end{itemize}
We will refer to these cases as the magnification case (subscript $\mu$ in formulae), and the strong lensing case (subscript SL in formulae), respectively. We will ignore the additional case, of a compound lens, with several significant perturbers. 

The magnification case has no primary lens plane, and is chiefly relevant for the magnifications of distant objects. In the absence of a primary lens plane, we are free to define the effective convergence on any point; the effective convergence is the same, independant of the plane choosen. It can be shown \citep[\eg][]{xxx} that if there are several mass sheets at redshifts $\{z_{p}\}$, with convergences $\{\kappa_p =\Sigma_{p}/\Sigma_{\mathrm{cr}}(z_p)\}$, the effective convergence is given by
\be \label{eq:kappasummu}
\kappa_{\mathrm{effective,\mu}}=\sum_{p}\kappa_p.
\ee

In the stong lensing case, the presence of a significant perturber alters the geometry of the system, and provides a primary lens plane. It is the primary lens plane upon which we need to know $\kappa_{\mathrm{effective}}$, since this is where the mass-sheet degeneracy is defined. Following Equations 20--32 of \citet{keeton2003}\flag{keeton2003}, it can be shown that the relevant effective convergence is given by 
\be \label{eq:kappasumSL}
\kappa_{\mathrm{effective,SL}}=
{  
(1-\beta_{12})(\kappa-\beta_{12}(\kappa^2-\gamma^2))
\over
(1-\beta_{12}\kappa)^2-(\beta_{12}\gamma)^2
}
\ee
where $\kappa$ and $\gamma$ are, respectively, the convergence and shear caused by the perturber, in their own plane and $\beta_{12}$ is a geometrical scaling factor defined by
\be\label{eq:beta}
\beta_{12}={
D_{12} D_{\mathrm{os}}
\over
D_{\mathrm{o}1} D_{1\mathrm{s}}
}
\ee
where the D's are again angular diameter distances: the 1 (2) in the subscript refers to the lower (higher) redshift object of the lens and perturber. For the case that the mass sheet is in the lens plane, $\beta_{12} = 0$ and $\kappa_{\mathrm{eff}}=\kappa$; if the mass-sheet is in the plane of the observer, or source, $\beta_{12} = 1$ and $\kappa_{\mathrm{eff}}=0$; for a mass-sheet at any other redshift $0<\beta_{12}<1$. In the case of several mass sheets the effective convergences sum. In the limit that both $\kappa$ and $\gamma$ are small, Equation \ref{eq:kappasumSL} reduces to 
\be \label{eq:kappasumSLweak}
\kappa_{\mathrm{effective,SL}}=(1-\beta_{12})\kappa;
\ee
it is this $\kappa_{\mathrm{effective,SL}}$ that we use as $\kappax$ for the strong lensing time delay analysis in \ref{sec:Dt}.


The time-delay distance is defined as
\be \label{eq:dt}
\Dt \equiv (1+\zd) D_{\rm d} D_{\rm s}/D_{\rm ds},
\ee
with which Equation \ref{eq:T} can be rephrased as
\be
\Delta t(\bmath{\theta},\bmath{\beta})  =  \frac{\Dt}{c} \, \phi(\bmath{\theta},\bmath{\beta})    ,
\ee 
Since the time delays are proportional to $1/ (1+ \kappax)$, if there is any external convergence, that is not included in the lens
modeling, then the time delay distance -- inferred assuming $\kappax = 0$ -- will be
$(1-\kappax)$ less than the true value of $\Dt$.
\be 
\label{eq:MassSheet:H0bias}
\Dt^{\rm{true}}=(1-\kappax) \Dt^{{\kappax = 0}}.
\ee
We can overcome this degeneracy if we have additional knowledge of $\kappax$.

For mass-sheets that are physically associated with the lens galaxy, the mass sheet
 affects the stellar dynamics of the
lens galaxy, so dynamical observations can break the internal
mass-sheet degeneracy by providing an additional estimate of the lens galaxy's mass
\citep[e.g.,][]{citations}. 

In this work our aim is to quantify the lensing effect of mass-sheets that are not physically associated with the lens galaxy -- mass-sheets
lying infront or behind the lens -- and the uncertainties induced by reconstructing
those mass-sheets using simple prescriptions applied to potential astronomical observables.
We also aim to quantify how uncertainties in the
estimations of $\kappax$ propogate into uncertainties on the cosmological parametres
which can be inferred from measurements of $\Dt$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Halo Model and Mass distribution}
\label{sec:model}

%Weak lensing by NFW halos. Accounting for mass along the line of sight.
%Approximations to full ray tracing:
%
%Halos. N-body sims provide mass framework. MS halo catalog. Truncated spherical
%NFW approx based on virial masses. Stellar mass. Halo map corresponding to
%ray-traced kappa map, for illustration. Small-scale structure 



For real lines of sight, it is nearly impossible to know the true $\kappax$ for a
line of sight, and without a knowledge of $\kappax^{\mathrm{true}}$ it is hard to
quantify if there is a bias induced by using different $\kappax$ estimators.
A source with known unlensed brightness e.g. a strongly lensed type Ia
Supernova \flag{cite some SNe papers} or a source of known unlensed size \flag{ideas?}
would break the mass-sheet degeneracy and provide a value for $\kappax$, but
\flag{no?} such systems are currently known.

Cosmological dark matter simulations can be used to generate mock lines of sight...
\flag{Stefan's section on how the ray tracing was done and how halos are extracted from
 the MS n-body particles}

With this catalogue of halos, positions, redshifts etc. it is possible to attempt
a reconstruction of the convergernce induced by every halo near a line of sight.
Cosmological dark matter simulations have shown that dark matter halos are well
approximated by NFW profiles \citep{NFW1997}, with a density profile given by
\be\label{eq:rhonfw}
\rho(r) = 
\frac{\rho_0}{\left(r/r_{s}\right)
\left(1+r/r_{s}\right)^{2}},
\ee
where $r_{s}$ is a characteristic radius of the cluster, representing where
the density slope transitions from $r^{-1}$ to $r^{-3}$. This radius is related
to the virial radius of the halo by $r_{s}~=~r_{200}/c$, where $r_{200}$ is the radius at 
which 
\be
\rho(r_{200}) = 200\rho_{{\mathrm{crit}}}(z), \text{ where } \rho_{\mathrm{crit}}(z) \equiv \frac{3H^{2}(z)}{8\pi G}
\ee
and $c$ is the concentration parameter, which can be estimated from the halo's mass,
using a mass--concentration relation. Typically more massive halos are less concentrated,
but there is some scatter; we use the relation of \citet{neto2007} to estimate $c$
from the mass enclosed within $r_{200}$, which we denote as $M_{200}$. The best fit relation of \citet{neto2007} is given by
\be
c_{200} = 4.67 (M_{200}/10^{14} h^{-1} \Msun)^{-0.11}.
\ee
$\rho_0$ is calculated from the critical density and concentration parameter:
\be
\rho_0 = \rho_{\mathrm{crit}}(z)\frac{200}{3}\frac{c^{3}}{\ln(1+c)-c/(1+c)}.
\ee

Unphysically, if one integrates the density profile of an NFW profile, the total mass is divergent.
Similarly, if the universe is homogeneously populated with NFW halos, the projected surface mass along any
line of sight will also be divergant\footnote{At large radius, $\Sigma_{\rm nfw} \propto R^{-2}$, but the differential number of halos centred within an annulus of width $\dee R$ is given by $\dee N_{\rm annulus} \propto R \dee R$, so  $\Sigma_{\rm total} \propto \int_{0}^{\infty} R^{-1} \dee R$, which diverges logarithmically}. Since infinite mass is unphysical, the profile must be truncated at some point. \flag{previous truncation results}. Several truncation profiles have been suggested \citep[e.g][]{BMO}, but beyond several virial radii, the amount of matter associated with a halo is likely to be low; \citet{Nandra2012} showed that the Universe's expansion can place an upper limit on the radius of NFW halos -- for cluster scale halos, this happens at around 25 times the NFW scale radius. In \Sref{sec:knownMh+z} we investigate how different truncations affect the recovered total convergence for a line of sight, using the truncated NFW profile of \citet{BMO}
\be\label{eq:bmoprofile}
\rho(r) = 
\frac{\rho_{\rm NFW} (r)}{1+\left(r/r_{t}\right)^2},
\ee
which is the same as the NFW profile in the limit that $r_t$ goes to infinity. The convergence and shear for the BMO profile are given in Appendix \ref{appendix:halos}.

Whilst halos contribute a positive convergence to $\kappax$, voids contribute a negative convergence. When a raybundle passes through a 
region of space that is less dense than $\rho_{\rm cr}(z)$ the rays are de-focused\footnote{In principle, the convergence caused by halos, is also caused by the overdensity, but we neglect this effect since halos are typically much more dense than the intergalactic medium}. Whilst the 
full raytraced solution takes into account the effect of voids, our reconstruction cannot -- the halo catalogue does not include voids. In principle the absence of a halo could be taken to infer a void, but the under-density of such a void is hard to infer. Instead, we shift our $\kappax$ values so that $\langle\kappax\rangle=0$. We refer to this corrective term as $\kappav$. The void correction introduces a source of error, since the inferred value of $\kappav$ will depend on the properties of the sightlines reconstructed, but this error shrinks with the number of sightlines reconstructed. To avoid potential biases we calculate $\kappav$ from randomly selected sightlines. The total $\kappax$ along the line of sight is given by 
\be \label{eq:totalkappax}
\kappax = \left(\sum_{\rm halos} \kappa_{\rm halo}\right)-\kappav.
\ee

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Tests with known halo mass and redshift}
\label{sec:knownMh+z} 

%Raytracing through n-body particles as 'truth'. Motivation for assuming perfect
%knowledge of halo mass and z = testing model of previous section. Deterministic
%prediction of kappa.
%
%Is truncation choice important? How deep and wide does a reconstruction need to
%go? What is the irreducible uncertainty on kappa from this halo model? (Bias and
%scatter) Can use the ideal reconstruction to ask: Where does the kappa come
%from? Close to the LoS? Bright objects? How many objects are important? What
%error is made by considering subsets of available objects? 


Given the halo mass catalogue from the Millenium Simulation, and convergence maps produced by
ray-tracing through the MS's n-body particles, 
it is possible to test the validity of the prescription outlined in Section \ref{sec:model}. We do this
using $\kapparay$ as a proxy for $\kappatrue$. The reconstruction prescription is tested given perfect
knowledge of the halos' virial masses and redshifts; this provides us with a measure of the intrinsic
errors induced by treating matter as truncated NFW halos. To quantify this 10000 lines of sight are chosen
from random positions in the catalogue, and for each line of sight we reconstruct the
convergences from every halo within 5 arcminutes and compare the reconstructed
kappas with those from the ray tracing results. The standard deviation on $\kapparay$-$\kapparec$ 
shown in Figure \ref{fig:ScattervsTruncation}. It is clear from Figure \ref{fig:ScattervsTruncation} 
that as long as the truncation is greater than a few virial radii, the choice of truncation
radius does not broadly affect the scatter on $\kapparay-\kapparec$; from now on we choose 
to truncate the halos at $5 \Rhalo$. Since $\sigma\left(\kapparay-\kapparec\right)$ does not go to
zero, it is clear that out halo based prescription does not perfectly replicate the n-body results, we refer to this
 as the intrinsic error of the prescription. The intrinsic error has a standard deviation of $\sigi \sim 0.018$, although
this figure is inflated by a few outliers in the tails of $\pr\left(\kapparay-\kapparec\right)$. Whilst we do not
focus on shear in this work, such outliers would likely be rejected by their reconstructed shear not matching the
shear of the lens model (see \citet{wong} for the practicalities of this), this makes our estimate of the intrinsic error pessimistic.

\begin{figure}
\includegraphics[width=\columnwidth]{truncation_scatter.eps}
\caption[magcut]{}
\label{fig:ScattervsTruncation}
\end{figure}

\tom{this paragraph is phrased badly}
If $\kapparec$ is to be used in a real survey it is important that it is not a biased estimator of the true $\kappax$. 
Ideally one wants $\langle \kapparec-\kappatrue \rangle$ to equal 0 and $\kapparec-\kappatrue$ to be independant of
$\kapparec$., since the void correction ensures $\langle \kapparec \rangle = 0$ any bias in $\langle \kapparec-\kapparay \rangle$ comes
from the variations in $\kapparay$. With 8.2$\times 10^8$ pixels, uniformly spaced over 196 deg$^2$ of simulated sky,
 $\langle \kapparay \rangle$ = -0.00014. However, it is improbable that such a large number of lines of sight
 could be reconstructed in reality and the mean of $\kappatrue$ for a small subset of sightlines will not necessarily
equal zero. We find this error to be
\be\label{eq:sigmav}
\sigma(\kappav) \simeq 0.036 / N^{\frac{1}{2}},
\ee
 where $N$ is the number of lines of sight, although $\pr(\kappav)$ has positive skew for small $N$.
 Care must be taken that the callibration lines of sight are not biased in $\kappax$ or the final $\pr(\kappav)$ will also be biased. For the rest of this work we use 1000  randomly chosen calibration lines of sight to calculate $\kappav$, introducing an error on $\kappax$ of $0.001$. 1000 callibration lines of sight is unfeasable currently, but should be reasonable in the LSST era. Since the true $\langle \kapparay \rangle$ = -0.00014 is two orders of magnitude smaller than intrinsic error of the halo prescription, $\kapparec$ can be seen as unbiased given a large enough sample of lines of sight. However since $\kappax$ reconstruction based on perfect knowledge of the halo mass and position is unrealistic we must re-visit the question of bias in Section \ref{sec:obsMstar+z}, using more realistic observables.

\comment{
 and Figure \ref{fig:bias} shows that there is no statistically significant evidence that $\kapparec$ is a biased estimator, regardless of the individual value of $\kapparec$.

\begin{figure}
\includegraphics[width=\columnwidth]{isitbiased.eps}
\caption[Biased?]{}
\label{fig:isitbiased}
\end{figure}
}
\begin{figure}
\includegraphics[width=\columnwidth]{mag_scatter.eps}
\caption[magcut]{}
\label{fig:magcut}
\end{figure}
\begin{figure}
\includegraphics[width=\columnwidth]{radius_scatter.eps}
\caption[radius cut]{}
\label{fig:radcut}
\end{figure}


The error from the void correction, and the intrinsic error from the halo based prescription are unavoidable errors, even with perfect knowledge of halo mass and position. Before investigating the errors caused by imperfect knowledge of halo mass and redshift, we investigate the errors induced by a magnitude limited reconstruction and a field of view limited reconstruction. The halos in our catalogue are given magnitudes by the semi-analytic model of \citet{SAM} and by applying magnitude cuts to our catalogue, we can investigate the scatter caused by unobserved halos. The majority of the convergence comes from halos with an $i$ magnitude between 18 and 24. Figure \ref{fig:magcut} shows that the width of $\kapparec-\kapparay$ decreases quickly between $i=18$ and $i=24$. Objects brighter than $i=18$ are either too rare or too close to the observer to make a significant contribution to the convergence. Objects fainter than $i=24$ are too small to be important unless they are extremely close to the line of sight where it is likely that neglecting stellar mass and using a spherical NFW prescription are too naive to adequately reconstruct $\kappax$ - it is likely that these ultra-faint halos (or substructures) are the major source of the scatter in $\kapparec-\kapparay$, but a deeper survey will not be sufficient to decrease the size of this scatter. Since a large number of callibration lines of sight are needed to shrink the width of $\pr(\kappav)$, it may prove unrealistic to reconstruct the calibration lines of sight out to 5 arcminutes. Figure \ref{fig:radcut} shows the width of $\kapparec-\kapparay$ as a function of reconstruction radius; in almost all cases there is no significant contribution to $\kappa$ from halos that are centred more than 1 arcminute away, although large groups or clusters can sometimes still make a contribution as far out as four arcminutes. For the rest of this work we will continue to model all of the halos out to 5 arminutes with an $i$ magnitude greater than 26, although a reconstruction with fields going out to two arcminutes and down to $i=24$ would do almost as well.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Tests on mock catalogs}
\label{sec:obsMstar+z}

Real attempts to reconstruct the convergence along a line of sight will not have direct access to the masses of dark matter halo, 
and will likely not have access to their spectroscopic redshift either. Instead these properties must be inferred from astrophysical
observables. In principle the only observables are astrometric positions, photometric colours and possibly spectra. In this section we
quantify the errors induced by inferring the halo mass and redshift from the observables. Much work has already focused on using
photometric colours to infer stellar mass \citep[\eg][]{xxx} and redshifts \citep[\eg][]{BPZ}, in line with these we shall use
stellar mass and photometric redshifts (with appropriate errors), as the observables that must be converted into an estimate
of $\kappax$. We will investigate three main sources of error: inferring halo mass given observed stellar mass; halos at the wrong redshift
due to photometric redshift error, and; the combination of both redshift and stellar mass errors.

We generate a stellar mass for each halo according to the stellar mass--halo mass relation of \citet{behroozi2010}. From this stellar mass we simulate 
an observed stellar mass by drawing a sample from $\pr(\log(M_{* \mathrm {obs}})|\log(M_{* \mathrm {true}}))$ which is given by the product of the galaxy stellar mass function (GSMF) of \citet{Fontana2006} and a Gaussian of width $\sigma_{M_*}$ centred on $\log(M*_{\mathrm {true}})$. Where a spectroscopic redshift exists stellar masses can be estimated with typical uncertainties of 0.15 dex \citep{xxx}, however with photometric redshifts stellar mass uncertainties are typically three times as large \citep{xxx}; we use $\sigma_{M_*}=0.15$ for halos with a spectroscopic redshift and $\sigma_{M_*}=0.45$ otherwise. The \citet{Fontana2006} GSMF is given by a Schechter function with redshift evolving parameters
\be
\label{eq:GSMF}
{\dee N \over \dee M_*} \propto \left(10^{(M_*-M_0(z))}\right)^{(1+\alpha(z))} \exp \left(-10^{(M_*-M_0(z))}\right)
\ee 
where $M_0(z)=11.16+0.17z-0.07z^2$ and $\alpha(z)=-1.18-0.082z$. For photometric redshift errors we draw a redshift from $\pr(z_{\rm true}|z_{\rm obs})$ which we take as a Gaussian of width $0.1(1+z_{\rm spec})$ centred on $z_{\rm spec}$, where $z_{\rm spec}$ is the halo's true redshift in \MS catalogue

\begin{figure}
\includegraphics[width=\columnwidth]{widthvkappa.eps}
\caption[radius cut]{}
\label{fig:width}
\end{figure}

Our results are summarized in Figure \ref{fig:width}. We reconstruct 10000 lines of sight and each of the reconstructed $\pr(\kappa)$ is summarized by their mean $\kapparec$, and their width containing $68\%$ of the probability, $\sigt$. Reconstructing the lines of sight with perfect knowledge of the redshift but an uncertain stellar mass, we find that $\sigt$ grows with $\kapparec$; this is not surprising since the low $\kapparec$ lines of sight are relatively empty and so there are few opportunities for uncertainties in the halo masses to propogate into $\kapparec$ uncertainties. Our results are well fit by a straight line given by 
\be
\sigt=0.012+0.26 \langle\kapparec\rangle;
\label{eq:Mstarfit}
\ee
this is the reconstruction error that could be expected from a complete spectroscopic survey of the field. A complete spetroscopic survey is unrealistic, but Equation \ref{eq:Mstarfit} represents a lower limit on the reconstruction error.
We find that with a perfect knowledge of the halo mass, but photometric redshifts the reconstructed $\pr(\kappa)$ has a mean $\sigt$ of 0.003. For the lines of sight with $\kapparec {\rm s}$ that are dominated by a single significant perturber the photometric redshift error can induce a larger uncertainty on $\kapparec$, but only $2.9 \%$ of sightlines have $\sigt > 0.01$; typical photometric redshift errors do not propogate into a significant uncertainties on $\kapparec$ if the halo mass is known. This is seen in Figure \ref{fig:width}, $\sigt$ is typically much larger for the perfect redshift reconstructions than the perfect mass reconstructions. The results are well fit by
\be
\sigt=0.0025+0.041\langle\kapparec\rangle
\label{eq:photozfit}
\ee
Inferring the stellar mass of a galaxy from its magnitude and colours requires an estimate of how far away the galaxy is; without a spectroscopic redshift the the infered stellar mass is less precise. In principle the photometric redshift is correlated with the infered stellar mass however we do not model this since the redshift error produces a small effect on the recovered $\pr(\kappa)$ when compared to the effect of uncertain stellar masses.  For the reconstructions with imperfect redshift and stellar mass the resulting uncertainty is significantly larger than the quadrature sum of the $\sigt {\rm s}$ in Equations \ref{eq:Mstarfit} and \ref{eq:photozfit}, this is because the uncertain redshift propogates into a broadened $\pr(M_{*})$. The  
ns than the perfect mass reconstructions. For a complete photometric survey down to $i=26$ our reconstructions are fit by the line
\be
\sigt=0.026+0.037\langle\kapparec\rangle
\label{eq:bothfit}
\ee
The fits are shown on Figure \ref{fig:intrinsicvsreconstruction}, where we compare the reconstruction errors with typical size of the intrinsic error from Section \ref{sec:knownMh+z}. With photometric redshifts only, the reconstruction error is typically half the size of the intrinsic error, but for a survey with complete spectroscopic coverage the two errors are of similar size. The photometric results can be greatly improved by the addition of spectroscopic redshifts for a small number of halos. Photometric redshifts are sufficient to estimate the $\kappa$ contribution from each halo; once this is know the most important halos can be targeted for spectroscopic follow-up. It is not always possible to get a spectroscopic redshift for faint objects, as such we use spectroscopic redshifts for galaxies with $i<24$ that the sitting in halos that individually contribute $\kappa>0.0005$. This selection corresponds to an average of $12 \pm 4$ galaxies per line of sight for which spectra are needed; the number of spectra needed per line of sight is shown as a histogram in Figure \ref{fig:spechist}. Such a spectroscopic survey yields only a modest improvement upon the purely photometric case being well fit by 
\be
\sigt=+\langle\kapparec\rangle
\label{eq:spec1fit}
\ee
This modest improvent appears counter intuitive, since spectra for all the subset of halos with $i<24, \kappat>0.0005$ halos contains the majority of the total $\kappax$ along alomst all lines of sight. The lack of significant improvement comes 
from the many massive halos that are intermediate distances from the line of sight; they do not contribute significantly to the true $\kappax$, but without spectroscopic reshifts their highly uncertain stellar masses propogate into broad $\pr(\Mhalo)$ and into small probability of large individual $\kappa$ contributions; since there are typically several hundred such objects within 5 arcminutes of the line of sight, their net contribution dominates the width of the photometrically generated $\pr(\kappax)$. However since massive objects are typically bright it is realtively fast to obtain their spectra with an 8~m class telescope. Galaxies with $i<22, \kappat>0.000001$ corresponds to roughly $200 \pm 100$ objects per line of sight; with spectroscopic redshifts for all of these plus the $i<24, \kappat>0.0005$ objects the reconstruction is greatly improved, being fit by
\be
\sigt=+\langle\kapparec\rangle
\label{eq:spec1fit}
\ee
The case of complete photometric coverage and partial spectroscopic coverage is closest to what might be expected from a real reconstruction of a field. We will refer to this as the 'hybrid' case for the rest of this paper, where all galaxies with $i<22, \kappat>0.000001$ or $i<24, \kappat>0.0005$ have spectra, but no others.


In Figure \ref{fig:intrinsicvsreconstruction} we show all of the fits, and compare them to the typical size of the difference between the ray-traced $\kapparay$ and the mean of the reconstructed $\kapparec$ which is a good measure of the intrinisic error in the reconstruction. For the purely photometric reconstruction $\sigt$ is larger than 98 percent of $|\kapparay - \langle \kapparec \rangle |$ indicating that the reconstruction is the dominant source of error. For the purely spectroscopic reconstruction $\sigt$ is larger than 44 percent of $|\kapparay - \langle \kapparec \rangle |$; the intrinsic error is slightly larger than the reconstruction error. For the hybrid case $\sigt$ is larger than 88 percent of $|\kapparay - \langle \kapparec \rangle |$, indicating that the intrinsic error is a sub-dominant effect. 

Since the reconstruction does not produce a symmetric $\pr(\kappax)$, we must take care in ensuring that the reconstruction has not biased $\langle \kapparec \rangle $ as an estimator of $\kapparay$. Figure 12 al


\begin{figure}
\includegraphics[width=\columnwidth]{spechist.eps}
\caption[spechist]{}
\label{fig:spechist}
\end{figure}


\begin{figure}
\includegraphics[width=\columnwidth]{intrinsicvsreconstruction.eps}
\caption[radius cut]{}
\label{fig:intrinsicvsreconstruction}
\end{figure}

We can draw samples from this PDF and ask:

How is the kappa inference offset and blurred by uncertainty on redshift, Mstar
and Mhalo? 

What is the effect of using the wrong Mstar-Mhalo relation? 








%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Time Delay Distances}
\label{sec:Dt} 

Folding the kappa uncertainties into time delay distance uncertainties. Toy
model: same zl and zs, allows simple product of pdfs to obtain estimate of P(D).

What is the expected bias and scatter (centroid position and width) of P(D) as a
function of N lenses? How does reconstruction compare with P(D) derived using
P(kappa|N45) for each lightcone? How does reconstruction compare with P(D)
derived assuming kappa=0 for each lightcone?

Also: compare with simple averaging. This will fail if lenses are selected to
live on over-dense lines of sight. Stefan's plot in Suyu et al shows effect of
selection - what is the resulting bias? Few percent? This is the target to beat,
need to find it out.

Make mock sample of lenses, all wit B1608 zd and zs, but with different kappas.
Draw kappas from Stefan's *lens* distribution. Can we correct for the selection
effect?


% %%%%%%%%%%%%%%%%%%%%%%%%%%%
% \begin{figure}
% \centering\includegraphics[width=0.99\linewidth]{figs/something.png}
% \caption{An example figure.}
% \label{fig:sizemass}
% \end{figure}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discuss}

Why reconstruction works or doesn't work.

Major sources of uncertainty.

Ideas for improving the procedure

Emphasize that this can be done before monitoring time is invested.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
\label{sec:conclude}

To remind you, this is what we did.

Our conclusions can be summarised as follows:

\begin{itemize}

\item We found this.

\item And we found this too.

\end{itemize}

% \item Faint galaxies and other dark structures will not appear in a photometric
% object catalog, but they will contribute convergence at some level. How much of
% the total external convergence in a time delay lens system comes from visible
% galaxies? How does this change as a function of magnitude cut? 

% \item Can the true (ray-traced) convergence be recovered by halo model
% reconstruction, and with what scatter and residual bias? Which aspects of the 
% model dominate these uncertainties?

% \item When faced with a newly-detected lens, surrounded by galaxies on the sky,
% we have some choices to make when planning follow-up observations.
% Which are the most important galaxies, with regard to the external convergence
% produced? Can nearby groups and clusters be straightforwardly accounted for? If
% lenses with such massive structures nearby are discarded, what impact does that
% have on the distance accuracy?



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgments}
 
TC thanks Vasily Belokurov for guidance and discussions.
We thank Risa Wechsler and Peter Behroozi for useful discussions and 
suggestions.
\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

\section{Truncated \LCDM halos}
\label{appendix:halos}

 Defining $x$ as the dimensionless projected radial distance $R/r_{s}$ and $\tau$ as the dimensionless truncation radius $r_{t}/r_{s}$, \citet{BMO} derives the projected mass density, which is given by:
\begin{align}\label{eq:kappaBMO}
\Sigma_{\rm}(x) = {2\tau^2 \over (\tau^2+1)^2}\left(
        {\tau^2+1\over x^2-1}\left(1-\mathcal{F}(x)\right)
        +
        2\mathcal{F}(x)\right.\nonumber\\
        -
        \left. {\pi \over \sqrt{\tau^2+x^2}}
        +
        {(\tau^2-1)\mathcal{L}(x,\tau)
        \over
        \tau\sqrt{\tau^2+x^2}}\right)
\end{align}
where $\mathcal{F}(x)$ and $\mathcal{L}(x,\tau)$ are defined as
\be\label{eq:F} 
\mathcal{F}(x) \equiv \begin{cases}  \frac{{\rm cos}^{-1} (1/x)}{\sqrt{x^2-1}} \hspace{0.2cm} & (x>1) \\
\\
\frac{4-x^2}{3}  & (x=1)\\
\\
\frac{ {\rm cosh}^{-1} (1/x)}{\sqrt{1-x^2}} & (x<1)
\end{cases}
\ee
\be\label{eq:L}
\mathcal{L}(x,\tau) = \ln\left(\frac{x}{\sqrt{\tau^2+x^2}+\tau}\right)
\ee
%the convergence is given by $\Sigma_{\rm BMO}(x) / \Sigma_{\rm cr}(z)$.

\flag{SHEAR HERE}





\section{Deriving the $\Mstar=\Mhalo$ relation}
\label{appendix:MSMH}

\section{Smooth component models}
\label{appendix:smooth}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:

% bubble -f paper-lcr.tex references.bib 
% \input{paper-lcr.bbl}

\bibliographystyle{apj}
\bibliography{references}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{lastpage}
\bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
